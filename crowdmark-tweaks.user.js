// ==UserScript==
// @name Crowdmark Tweaks
// @description Useful tweaks for Crowdmark
// @version 0.1.0-build.2025-10-11T02:40:37.063Z
// @author embeddedt
// @homepage https://github.com/embeddedt/crowdmark-tweaks
// @supportURL https://github.com/embeddedt/crowdmark-tweaks/issues
// @match https://app.crowdmark.com/*
// @connect app.crowdmark.com
// @downloadURL https://github.com/embeddedt/crowdmark-tweaks/raw/refs/heads/main/crowdmark-tweaks.user.js
// @grant GM_addStyle
// @grant GM_addElement
// @icon https://www.google.com/s2/favicons?sz=64&domain=crowdmark.com
// @namespace https://github.com/embeddedt
// @updateURL https://github.com/embeddedt/crowdmark-tweaks/raw/refs/heads/main/crowdmark-tweaks.meta.js
// ==/UserScript==

(()=>{"use strict";const t=/^https:\/\/app\.crowdmark\.com\/exams\/([^/]+)\/grading\/student\/(\d+)/;function o(){const o=window.location.href.match(t);return o?parseInt(o[2]):null}!function(){const t=history.pushState,o=history.replaceState;let n=location.href;function e(){const t=location.href;t!==n&&(n=t,function(){const t=new CustomEvent("urlchange",{detail:{url:location.href}});window.dispatchEvent(t)}())}history.pushState=function(...o){t.apply(this,o),e()},history.replaceState=function(...t){o.apply(this,t),e()},window.addEventListener("popstate",e)}();let n=new Set;function e(t){let o=n.size;return n.has(t)&&o--,o>0}function i(t){const o=t.target;return"INPUT"!==o.tagName&&"TEXTAREA"!==o.tagName&&!o.isContentEditable}function r(t,o){document.addEventListener("keydown",n=>{!i(n)||n.repeat||e(t)||n.key.toLowerCase()===t&&(n.stopImmediatePropagation(),n.preventDefault(),setTimeout(()=>o(),0))})}function l(t,o,r,l){const c=document.documentElement;let a="";function s(){c.classList.remove(o),n.delete(t),a=""}document.addEventListener("keydown",m=>{if(!i(m)||e(t)||l&&!l())return;const d=c.classList.contains(o),u=m.key.toLowerCase();if(d)if(1!==u.length||m.ctrlKey||m.altKey||m.metaKey||m.shiftKey)"Escape"===u&&s();else{a+=u,m.stopImmediatePropagation(),m.preventDefault();let t=!1;try{t=r(a)}catch(m){console.error("Error from keybind handler",m)}t||s()}else u===t&&(c.classList.add(o),n.add(t))})}function c(t){!function(t){if(t<0)return void console.error("refusing to enter negative grade");const o=function(){const t=document.querySelector(".evaluation__keypad"),o=Array.from(t.children).filter(t=>"BUTTON"===t.tagName),n=new Map;return o.forEach(t=>{const o=t.textContent.trim();o&&n.set(o,t)}),n}(),n=o.get("CLR");if(null==n)return void console.error("Can't find clear button");const e=[];for(;t>0;)e.unshift(t%10),t=Math.floor(t/10);n.click();for(let t of e){const n=o.get(t.toString());null==n?console.warn("Cannot find grading keypad button for",t):n.click()}}(function(){const t=document.querySelector(".evaluation__points");if(null==t)throw new Error("can't find current grade");let o=parseInt(t.textContent.trim(),10);return isNaN(o)&&(o=0),o}()+t)}function a(){return window.localStorage.getItem("cmtSecondsPerBooklet")??50}GM_addStyle('li.tool__lib-comment,span.lib-comment__text>div.processed-text{--us-height-override: 30px;height:var(--us-height-override) !important;line-height:var(--us-height-override) !important}.grading-toolbar__submenu--library{width:236px}.cmt-waiting-for-digit .grading-sidebar__evaluation .evaluation__score-block{border-color:red}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(1)::before{display:block;content:"0";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(2)::before{display:block;content:"1";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(3)::before{display:block;content:"2";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(4)::before{display:block;content:"3";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(5)::before{display:block;content:"4";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(6)::before{display:block;content:"5";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(7)::before{display:block;content:"6";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(8)::before{display:block;content:"7";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(9)::before{display:block;content:"8";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}.cmt-waiting-for-comment-idx ul.grading-toolbar__submenu--library{border:2px red solid}.cmt-grading-timer{background-color:#000;font-family:monospace;color:green;font-size:24px;text-align:center}.cmt-grading-timer.cmt-grading-timer-lagging{color:red}'),function(){let t=0;l("a","cmt-waiting-for-digit",o=>{const n=parseInt(o,10);isNaN(n)||(t=n,c(n))}),r("u",()=>{t>0&&(c(-t),t=0)}),r("d",()=>{c(-1)})}(),function(){let t,n,e=0;function i(){const o=document.querySelector(".grading-sidebar__container > .evaluation__list");if(!o||o.parentElement.querySelector(".cmt-grading-timer"))return;const e=document.createElement("div");e.classList.add("cmt-grading-timer"),e.textContent="00:00",o.parentElement.appendChild(e),n=e,t&&t.disconnect()}function l(t){e=t,n.textContent=function(t){const o=t<0?"-":"";t=Math.abs(t);const n=Math.floor(t/60),e=Math.floor(t%60);return`${o}${n.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`}(t),t<a()?n.classList.remove("cmt-grading-timer-lagging"):n.classList.add("cmt-grading-timer-lagging")}i(),t=new MutationObserver(()=>i()),t.observe(document.body,{childList:!0,subtree:!0});let c,s=o()??-1;function m(){null!=n&&l(e+1)}function d(){null!=c&&(u(),p())}function u(){null!=c&&(clearInterval(c),c=null)}function p(){null==c&&(c=setInterval(m,1e3))}window.addEventListener("urlchange",()=>{const t=o();null==t||s>=t||(s=t,l(e-a()),d())}),r("\\",()=>{l(0),d()}),document.hidden||p(),document.addEventListener("visibilitychange",()=>{document.hidden?u():p()})}();let s=0,m=0;var d,u;document.addEventListener("mousemove",t=>{s=t.clientX,m=t.clientY}),l("w","cmt-waiting-for-comment-idx",(d=function(){const t=new Map,o=document.querySelector("ul.grading-toolbar__submenu--library");if(o){const n=Array.from(o.querySelectorAll("li.tool__lib-comment:not(.lib-comment--no-comment)"));for(let o=0;o<n.length;o++){const e=n[o],i=e.querySelector("span:nth-child(1 of .MathJax) mphantom");if(null!=i){const o=i.textContent.trim();t.has(o)||t.set(o,e)}if(o<10){const n=((o+1)%10).toString();t.set(n,e)}}}return t},u=function(t){console.log("Auto-apply comment",t),function(t,o,n){const e=t.getBoundingClientRect(),i=e.left+e.width/2,r=e.top+e.height/2;function l(t,o,n,e=document.elementFromPoint(o,n)){if(!e)return void console.warn("can't find target to fire event to");const i=new MouseEvent(t,{bubbles:!0,cancelable:!0,clientX:o,clientY:n,buttons:1});e.dispatchEvent(i)}l("mousedown",i,r,t);for(let t=1;t<=20;t++)l("mousemove",i+t/20*(o-i),r+t/20*(n-r));l("mouseup",o,n,document.elementFromPoint(o,n))}(t,s,m)},t=>{const o=function(t,o){let n=null,e=0;for(const[i,r]of t)if(i.startsWith(o)){if(e++,e>1)return{status:"conflict"};n=r}return null!=n?{status:"unique",value:n}:{status:"none"}}(d(),t);return"none"==o.status?(console.warn("no matching value found"),!1):"conflict"==o.status||(u(o.value),!1)}),()=>{const t=document.elementFromPoint(s,m);return null!==t?.closest(".grading-canvas__image-capture-container")})})();