// ==UserScript==
// @name Crowdmark Tweaks
// @description Useful tweaks for Crowdmark
// @version 0.1.0-build.2025-10-18T02:11:46.231Z
// @author embeddedt
// @homepage https://github.com/embeddedt/crowdmark-tweaks
// @supportURL https://github.com/embeddedt/crowdmark-tweaks/issues
// @match https://app.crowdmark.com/*
// @connect app.crowdmark.com
// @connect localhost
// @downloadURL https://github.com/embeddedt/crowdmark-tweaks/raw/refs/heads/main/crowdmark-tweaks.user.js
// @grant GM_addStyle
// @grant GM_addElement
// @grant GM_xmlhttpRequest
// @grant window.onurlchange
// @icon https://www.google.com/s2/favicons?sz=64&domain=crowdmark.com
// @namespace https://github.com/embeddedt
// @updateURL https://github.com/embeddedt/crowdmark-tweaks/raw/refs/heads/main/crowdmark-tweaks.meta.js
// ==/UserScript==

(()=>{"use strict";const t=/^https:\/\/app\.crowdmark\.com\/exams\/([^/]+)\/grading\/student\/(\d+)/;function o(){return null!=window.location.href.match(t)}function n(){const o=window.location.href.match(t);return o?parseInt(o[2]):null}!function(){const t=history.pushState,o=history.replaceState;let n=location.href;function e(){const t=location.href;t!==n&&(n=t,function(){const t=new CustomEvent("urlchange",{detail:{url:location.href}});window.dispatchEvent(t)}())}history.pushState=function(...o){t.apply(this,o),e()},history.replaceState=function(...t){o.apply(this,t),e()},window.addEventListener("popstate",e)}();let e=new Set;function r(t){let o=e.size;return e.has(t)&&o--,o>0}function i(t){const o=t.target;return"INPUT"!==o.tagName&&"TEXTAREA"!==o.tagName&&!o.isContentEditable}function c(t,o,n=()=>!0){document.addEventListener("keydown",e=>{i(e)&&!e.repeat&&!r(t)&&n()&&e.key.toLowerCase()===t&&(e.stopImmediatePropagation(),e.preventDefault(),setTimeout(()=>o(),0))})}function a(t,o,n,c){const a=document.documentElement;let l="";function s(){a.classList.remove(o),e.delete(t),l=""}document.addEventListener("keydown",m=>{if(!i(m)||r(t)||c&&!c())return;const d=a.classList.contains(o),u=m.key.toLowerCase();if(d)if(1!==u.length||m.ctrlKey||m.altKey||m.metaKey||m.shiftKey)"escape"===u&&s();else{l+=u,m.stopImmediatePropagation(),m.preventDefault();let t=!1;try{t=n(l)}catch(m){console.error("Error from keybind handler",m)}t||s()}else u===t&&(a.classList.add(o),e.add(t))})}function l(t){!function(t){if(t<0)return void console.error("refusing to enter negative grade");const o=function(){const t=document.querySelector(".evaluation__keypad"),o=Array.from(t.children).filter(t=>"BUTTON"===t.tagName),n=new Map;return o.forEach(t=>{const o=t.textContent.trim();o&&n.set(o,t)}),n}(),n=o.get("CLR");if(null==n)return void console.error("Can't find clear button");const e=[];for(;t>0;)e.unshift(t%10),t=Math.floor(t/10);n.click();for(let t of e){const n=o.get(t.toString());null==n?console.warn("Cannot find grading keypad button for",t):n.click()}}(function(){const t=document.querySelector(".evaluation__points");if(null==t)throw new Error("can't find current grade");let o=parseInt(t.textContent.trim(),10);return isNaN(o)&&(o=0),o}()+t)}function s(){return window.localStorage.getItem("cmtSecondsPerBooklet")??50}let m=0,d=0;function u(t,o,n,e=document.elementFromPoint(o,n)){if(!e)return void console.warn("can't find target to fire "+t+" event to");const r=new MouseEvent(t,{bubbles:!0,cancelable:!0,clientX:o,clientY:n,buttons:1});e.dispatchEvent(r)}function f(){return m}function p(){return d}document.addEventListener("mousemove",t=>{m=t.clientX,d=t.clientY}),function(){const t="ul.grading-toolbar__submenu.grading-toolbar__submenu--library",o="cmt-comment-virtualization-workaround";function n(t){if(!t||t.parentElement?.classList.contains(o))return;const n=document.createElement("div");n.className=o,t.replaceWith(n),n.appendChild(t)}const e=document.querySelector(t);let r;e&&n(e),r=new MutationObserver(o=>{for(const e of o)for(const o of e.addedNodes){if(!(o instanceof HTMLElement))continue;const e=o.matches(t)?o:o.querySelector(t);e&&n(e)}}),r.observe(document.body,{childList:!0,subtree:!0})}();let b=[];window.addEventListener("urlchange",()=>{b=[]});const g="cmt_config:";function h(){const t=document.elementsFromPoint(f(),p());for(const o of t){const t=o.closest("div.comment__preview");if(null!=t)return t}return null}async function y(t){!function(t){const o=t.getBoundingClientRect(),n=o.x+o.width/2,e=o.y+o.height/2;u("mousedown",n,e,t),u("mouseup",n,e,t),u("click",n,e,t)}(t),(await async function(t,o){return new Promise(n=>{const e=new MutationObserver(t=>{for(const r of t)for(const t of r.addedNodes)if(t instanceof HTMLElement&&o(t))return e.disconnect(),void n(t)});e.observe(t,{childList:!0,subtree:!0})})}(t.parentElement,t=>"BUTTON"==t.tagName&&"Delete"==t.textContent.trim()&&null!=t.closest(".comment__footer"))).click()}var _,k;a("w","cmt-waiting-for-comment-idx",(_=function(){const t=new Map,o=new Map;async function n(t,o=f(),n=p()){console.log("Auto-apply comment",t),function(t,o,n){const e=t.getBoundingClientRect(),r=e.left+e.width/2,i=e.top+e.height/2;u("mousedown",r,i,t);for(let t=1;t<=20;t++)u("mousemove",r+t/20*(o-r),i+t/20*(n-i));u("mouseup",o,n,document.elementFromPoint(o,n))}(t,o,n);const e=b[b.length-1],r=await async function(t,o=f(),n=p()){let e=0;for(;;){const r=document.elementsFromPoint(o,n).find(t);if(r)return r;if(e++,e>=100)throw new Error("Could not find element");await new Promise(t=>setTimeout(t,50))}}(t=>t.classList.contains("comment__preview-container"),o+10,n+10);return e.push(r),r}const e=document.querySelector("ul.grading-toolbar__submenu--library");if(e){const r=Array.from(e.querySelectorAll("li.tool__lib-comment:not(.lib-comment--no-comment)"));for(let e=0;e<r.length;e++){const i=r[e],c=i.querySelector("span:nth-child(1 of .MathJax) mphantom");if(null!=c){const e=c.textContent.trim();t.has(e)||(o.set(e,i),t.set(e,()=>n(i)))}if(e<10){const r=((e+1)%10).toString();o.set(r,i),t.set(r,()=>n(i))}}}async function r(t){console.log("Apply group ",t);let e=f(),r=p();for(const i of t){const t=o.get(i);if(null==t){console.warn("missing comment",i);continue}const c=await n(t,e,r);null==c?(console.warn("can't find applied comment"),r+=30):r+=c.getBoundingClientRect().height+5}}const i=function(){const t=document.querySelector("ul.grading-toolbar__submenu--library");if(t){const o=Array.from(t.querySelectorAll("li.tool__lib-comment:not(.lib-comment--no-comment)"));for(let t of o){const o=t.querySelector(".lib-comment__text")?.textContent.trim()??"";if(o.startsWith(g))try{return JSON.parse(o.substring(11))}catch(t){console.error("Invalid CMT config found",t)}}}return{}}();if(void 0!==i.groups)for(let[o,n]of Object.entries(i.groups))t.set(o,()=>r(n));return t},k=t=>{b.push([]),t()},t=>{const o=function(t,o){let n=null,e=0;for(const[r,i]of t)if(r.startsWith(o)){if(e++,e>1)return{status:"conflict"};n=i}return null!=n?{status:"unique",value:n}:{status:"none"}}(_(),t);return"none"==o.status?(console.warn("no matching value found"),!1):"conflict"==o.status||(k(o.value),!1)}),()=>{const t=document.elementFromPoint(f(),p());return null!==t?.closest(".grading-canvas__image-capture-container")}),c("x",()=>{const t=h();null!=t&&y(t)},()=>null!=h()),c("u",async()=>{const t=b.pop();for(const o of t)await y(o)},()=>b.length>0);let w=null;c(";",async()=>{const t=document.elementsFromPoint(f(),p()).filter(t=>"DIV"===t.tagName&&t.classList.contains("grading-canvas__image-capture-container"));if(0==t.length)return void console.warn("cannot find image under mouse");const o=t[0].querySelector("img.cm__lazy-img__img");null!=w&&w.abort(),w=new AbortController,console.log("Starting AI transcription");const n=function(){let t=document.querySelector("#cmt-ai-assist-popover");return null==t&&(t=document.createElement("div"),t.id="cmt-ai-assist-popover",document.querySelector("section.grading-canvas").appendChild(t)),t}();n.innerHTML="Processing...",GM_xmlhttpRequest({method:"POST",url:"http://localhost:3000/vision",headers:{"Content-Type":"application/json"},data:JSON.stringify({imageUrl:o.src}),responseType:"stream",onerror:function(t){console.error("Error while trying to transcribe",t)},onloadstart:async function(t){!async function(t,o){console.log("waiting for streamed data");const n=o.response.getReader(),e=new TextDecoder;let r;t.innerHTML="";let i="";function c(){r=document.createElement("p"),t.appendChild(r),i=""}for(c();;){const{value:t,done:o}=await n.read();if(o)break;const a=e.decode(t,{stream:!0});for(const t of a.split("\n").filter(Boolean))try{const o=JSON.parse(t);if(o.response)for(const t of o.response)"\n"===t?(c(),i=""):(i+=t,r.textContent=i,MathJax.Hub.Queue(["Typeset",MathJax.Hub,r]))}catch(t){console.warn(t)}}console.log("--- Stream complete ---")}(n,t)}})}),GM_addStyle('li.tool__lib-comment,span.lib-comment__text>div.processed-text{--us-height-override: 30px;height:var(--us-height-override) !important;line-height:var(--us-height-override) !important}.grading-toolbar__submenu--library{width:236px}.cmt-waiting-for-digit .grading-sidebar__evaluation .evaluation__score-block{border-color:red}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(1)::before{display:block;content:"0";position:absolute;right:4px;bottom:50%;transform:translateY(50%);padding:1px;line-height:normal !important;background-color:#ccc;border:1px #777 solid}[data-darkreader-scheme=dark] li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(1)::before{background-color:#444}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(2)::before{display:block;content:"1";position:absolute;right:4px;bottom:50%;transform:translateY(50%);padding:1px;line-height:normal !important;background-color:#ccc;border:1px #777 solid}[data-darkreader-scheme=dark] li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(2)::before{background-color:#444}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(3)::before{display:block;content:"2";position:absolute;right:4px;bottom:50%;transform:translateY(50%);padding:1px;line-height:normal !important;background-color:#ccc;border:1px #777 solid}[data-darkreader-scheme=dark] li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(3)::before{background-color:#444}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(4)::before{display:block;content:"3";position:absolute;right:4px;bottom:50%;transform:translateY(50%);padding:1px;line-height:normal !important;background-color:#ccc;border:1px #777 solid}[data-darkreader-scheme=dark] li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(4)::before{background-color:#444}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(5)::before{display:block;content:"4";position:absolute;right:4px;bottom:50%;transform:translateY(50%);padding:1px;line-height:normal !important;background-color:#ccc;border:1px #777 solid}[data-darkreader-scheme=dark] li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(5)::before{background-color:#444}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(6)::before{display:block;content:"5";position:absolute;right:4px;bottom:50%;transform:translateY(50%);padding:1px;line-height:normal !important;background-color:#ccc;border:1px #777 solid}[data-darkreader-scheme=dark] li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(6)::before{background-color:#444}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(7)::before{display:block;content:"6";position:absolute;right:4px;bottom:50%;transform:translateY(50%);padding:1px;line-height:normal !important;background-color:#ccc;border:1px #777 solid}[data-darkreader-scheme=dark] li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(7)::before{background-color:#444}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(8)::before{display:block;content:"7";position:absolute;right:4px;bottom:50%;transform:translateY(50%);padding:1px;line-height:normal !important;background-color:#ccc;border:1px #777 solid}[data-darkreader-scheme=dark] li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(8)::before{background-color:#444}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(9)::before{display:block;content:"8";position:absolute;right:4px;bottom:50%;transform:translateY(50%);padding:1px;line-height:normal !important;background-color:#ccc;border:1px #777 solid}[data-darkreader-scheme=dark] li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(9)::before{background-color:#444}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(10)::before{display:block;content:"9";position:absolute;right:4px;bottom:50%;transform:translateY(50%);padding:1px;line-height:normal !important;background-color:#ccc;border:1px #777 solid}[data-darkreader-scheme=dark] li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(10)::before{background-color:#444}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(11)::before{display:block;content:"0";position:absolute;right:4px;bottom:50%;transform:translateY(50%);padding:1px;line-height:normal !important;background-color:#ccc;border:1px #777 solid}[data-darkreader-scheme=dark] li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(11)::before{background-color:#444}.cmt-grading-timer{background-color:#000;font-family:monospace;color:green;font-size:24px;text-align:center}.cmt-grading-timer.cmt-grading-timer-lagging{color:red}.cmt-comment-virtualization-workaround{resize:both;position:absolute;top:56px;left:0;display:flex;flex-direction:column}.cmt-comment-virtualization-workaround>.grading-toolbar__submenu--library{resize:none;height:initial !important;position:static;width:100% !important;flex:1 0 auto;border-radius:0}.cmt-comment-virtualization-workaround{width:236px;overflow-y:auto;overflow-x:hidden;border:2px rgba(0,0,0,0) solid;border-radius:4px}.cmt-waiting-for-comment-idx .cmt-comment-virtualization-workaround{border-color:red}#cmt-ai-assist-popover{position:fixed;right:240px;top:5rem;background-color:#222;color:#fff;border-radius:1rem;width:600px;height:400px;z-index:1000;overflow-y:auto;padding:1em;font-size:14px}#cmt-ai-assist-popover p{margin-bottom:.5em}.cm-comment.is-editing{z-index:100}'),function(){let t=0;a("a","cmt-waiting-for-digit",o=>{const n=parseInt(o,10);isNaN(n)||(t=n,l(n))}),c("u",()=>{t>0&&(l(-t),t=0)}),c("d",()=>{l(-1)})}(),function(){let t,e,r=0,i=o();function a(){const o=document.querySelector(".grading-sidebar__container > .evaluation__list");if(!o||o.parentElement.querySelector(".cmt-grading-timer"))return;const n=document.createElement("div");n.classList.add("cmt-grading-timer"),n.textContent="00:00",o.parentElement.appendChild(n),e=n,t&&t.disconnect()}function l(t){r=t,e.textContent=function(t){const o=t<0?"-":"";t=Math.abs(t);const n=Math.floor(t/60),e=Math.floor(t%60);return`${o}${n.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`}(t),t<s()?e.classList.remove("cmt-grading-timer-lagging"):e.classList.add("cmt-grading-timer-lagging")}a(),t=new MutationObserver(()=>a()),t.observe(document.body,{childList:!0,subtree:!0});let m,d=n()??-1;function u(){null!=e&&i&&l(r+1)}function f(){null!=m&&(p(),b())}function p(){null!=m&&(clearInterval(m),m=null)}function b(){null==m&&(m=setInterval(u,1e3))}window.addEventListener("urlchange",()=>{const t=i;i=o();const e=n();null==e||d>=e||(d=e,t&&l(r-s()),f())}),c("\\",()=>{l(0),f()}),document.hidden||b(),document.addEventListener("visibilitychange",()=>{document.hidden?p():b()})}()})();