// ==UserScript==
// @name Crowdmark Tweaks
// @description Useful tweaks for Crowdmark
// @version 0.1.0-build.2025-10-27T01:03:05.300Z
// @author embeddedt
// @homepage https://github.com/embeddedt/crowdmark-tweaks
// @supportURL https://github.com/embeddedt/crowdmark-tweaks/issues
// @match https://app.crowdmark.com/*
// @connect app.crowdmark.com
// @connect localhost
// @downloadURL https://github.com/embeddedt/crowdmark-tweaks/raw/refs/heads/main/crowdmark-tweaks.user.js
// @grant GM_addStyle
// @grant GM_addElement
// @grant GM_xmlhttpRequest
// @grant window.onurlchange
// @icon https://www.google.com/s2/favicons?sz=64&domain=crowdmark.com
// @namespace https://github.com/embeddedt
// @updateURL https://github.com/embeddedt/crowdmark-tweaks/raw/refs/heads/main/crowdmark-tweaks.meta.js
// ==/UserScript==

(()=>{var e={244:()=>{document.body.classList.add("cm-tweaks-fast-grading-switch-enabled");const e=new MutationObserver(e=>{for(const t of e)if("attributes"===t.type&&"class"===t.attributeName){const e=t.target;if(e.matches("article.grading-canvas__item.grading-canvas__page")&&e.classList.contains("is-active")){console.log("trigger image load");try{window.dispatchEvent(new Event("resize"))}catch(e){}}}});document.querySelectorAll("article.grading-canvas__item.grading-canvas__page").forEach(t=>e.observe(t,{attributes:!0})),new MutationObserver(t=>{for(const n of t)for(const t of n.addedNodes)t instanceof HTMLElement&&t.matches("article.grading-canvas__item.grading-canvas__page")&&e.observe(t,{attributes:!0})}).observe(document.body,{childList:!0,subtree:!0})}},t={};function n(o){var r=t[o];if(void 0!==r)return r.exports;var i=t[o]={exports:{}};return e[o](i,i.exports,n),i.exports}(()=>{"use strict";const e=/^https:\/\/app\.crowdmark\.com\/exams\/([^/]+)\/grading\/student\/(\d+)\/question\/([^/]+)/;function t(){return null!=window.location.href.match(e)}function o(){const t=window.location.href.match(e);return t?parseInt(t[2]):null}!function(){const e=history.pushState,t=history.replaceState;let n=location.href;function o(){const e=location.href;e!==n&&(n=e,function(){const e=new CustomEvent("urlchange",{detail:{url:location.href}});window.dispatchEvent(e)}())}history.pushState=function(...t){e.apply(this,t),o()},history.replaceState=function(...e){t.apply(this,e),o()},window.addEventListener("popstate",o)}();let r=new Set;function i(e){let t=r.size;return r.has(e)&&t--,t>0}function a(e){const t=e.target;return"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName&&!t.isContentEditable}function c(e,t,n=()=>!0){document.addEventListener("keydown",o=>{a(o)&&!o.repeat&&!i(e)&&n()&&o.key.toLowerCase()===e&&(o.stopImmediatePropagation(),o.preventDefault(),setTimeout(()=>t(),0))})}function s(e,t,n,o,c){c||(c=()=>{});const s=document.documentElement;let l="";function d(){s.classList.remove(t),r.delete(e),l="",c(null)}document.addEventListener("keydown",m=>{if(!a(m)||i(e)||o&&!o())return;const u=s.classList.contains(t),f=m.key.toLowerCase();if(u)if(1!==f.length||m.ctrlKey||m.altKey||m.metaKey||m.shiftKey)"escape"===f&&d();else{l+=f,m.stopImmediatePropagation(),m.preventDefault();let e=!1;try{e=n(l)}catch(m){console.error("Error from keybind handler",m)}e?c(l):d()}else f===e&&(s.classList.add(t),r.add(e),c(""))})}function l(e){!function(e){if(e<0)return void console.error("refusing to enter negative grade");const t=function(){const e=document.querySelector(".evaluation__keypad"),t=Array.from(e.children).filter(e=>"BUTTON"===e.tagName),n=new Map;return t.forEach(e=>{const t=e.textContent.trim();t&&n.set(t,e)}),n}(),n=t.get("CLR");if(null==n)return void console.error("Can't find clear button");const o=[];for(;e>0;)o.unshift(e%10),e=Math.floor(e/10);n.click();for(let e of o){const n=t.get(e.toString());null==n?console.warn("Cannot find grading keypad button for",e):n.click()}}(function(){const e=document.querySelector(".evaluation__points");if(null==e)throw new Error("can't find current grade");let t=parseInt(e.textContent.trim(),10);return isNaN(t)&&(t=0),t}()+e)}function d(){return window.localStorage.getItem("cmtSecondsPerBooklet")??50}let m=0,u=0;function f(e,t,n,o=document.elementFromPoint(t,n)){if(!o)return void console.warn("can't find target to fire "+e+" event to");const r=new MouseEvent(e,{bubbles:!0,cancelable:!0,clientX:t,clientY:n,buttons:1});o.dispatchEvent(r)}function h(){return m}function g(){return u}document.addEventListener("mousemove",e=>{m=e.clientX,u=e.clientY});class p{element;children;usages;constructor(){this.clear()}insertChild(e,t){const n=this.getNestedTrieForPrefix(e);null==n?this._insertChild(e,0,t):n.element=t}_insertChild(e,t,n){if(this.usages++,t==e.length){if(null!=this.element)throw new Error("Multiple attempts to insert to the same node");return void(this.element=n)}this.children||(this.children=new Map);const o=e.charAt(t);let r;this.children.has(o)?r=this.children.get(o):(r=new p,this.children.set(o,r)),r._insertChild(e,t+1,n)}visit(e){if(this.element)e("",this.element);else if(null!=this.children)for(const[t,n]of this.children.entries())n.visit((n,o)=>{e(t+n,o)})}forEachValue(e){if(this.element)e(this.element);else if(null!=this.children)for(const t of this.children.values())t.forEachValue(e)}getNestedTrieForPrefix(e){return this._getNestedTrieForChar(e,0)}_getNestedTrieForChar(e,t){if(t==e.length)return this;if(null!=this.children){const n=e.charAt(t),o=this.children.get(n);if(o)return o._getNestedTrieForChar(e,t+1)}return null}get(e){const t=this.getNestedTrieForPrefix(e);return t?.element??null}clear(){this.usages=0,this.element=null,this.children=null}_getUniqueContainedElement(){if(null!=this.element)return this.element;if(this.children&&1==this.children.size)return[...this.children.values()][0]._getUniqueContainedElement();throw new Error("Contained element not found")}createKeybindHandler(e){return t=>{const n=this.getNestedTrieForPrefix(t);return null==n||0==n.usages?(console.warn("no matching value found"),!1):n.usages>1||(e(n._getUniqueContainedElement()),!1)}}size(){return this.usages}toString(){const e=[];return this.visit((t,n)=>{e.push(t+" -> "+n)}),"Trie{"+e.join(", ")+"}"}}let w=null,v=null;!function(){const e="ul.grading-toolbar__submenu.grading-toolbar__submenu--library",t="cmt-comment-virtualization-workaround";function n(e){if(!e||e.parentElement?.classList.contains(t))return;const n=document.createElement("div");n.className=t,e.replaceWith(n),n.appendChild(e),v=document.createElement("span"),v.classList.add("cm-tweaks-search-visual"),n.appendChild(v),w=n,function(e){function t(t){if(t.classList.contains("cm-tweaks-macro-comment"))return;let n=0,o=[];const r=t.textContent.match(b);r&&o.push(r[1]);for(const r of e.children){if("LI"===r.tagName&&r.classList.contains("tool__lib-comment")&&n++,n>10)break;if(n>=1&&r===t){const e=n.toString();o.includes(e)||o.push(e);break}}if(o.length>0){const e=document.createElement("div");e.classList.add("cm-tweaks-comment-macro-indicator-container"),t.insertBefore(e,t.firstChild);for(const n of o){const o=document.createElement("span");o.textContent=n,o.classList.add("cm-tweaks-comment-macro-indicator"),e.appendChild(o),y.insertChild(n,{rawElement:t,applyHandler:()=>_(t)})}}}function n(){for(const t of Array.from(e.querySelectorAll(".cm-tweaks-comment-macro-indicator")))t.parentNode.removeChild(t);y.clear();for(const n of e.querySelectorAll("li.tool__lib-comment:not(.lib-comment--loading)"))"LI"===n.tagName&&t(n);const n=function(){const e=document.querySelector("ul.grading-toolbar__submenu--library");if(e){const t=Array.from(e.querySelectorAll("li.tool__lib-comment:not(.lib-comment--no-comment)"));for(let e of t){const t=e.querySelector(".lib-comment__text")?.textContent.trim()??"";if(t.startsWith(E))try{return JSON.parse(t.substring(E.length))}catch(e){console.error("Invalid CMT config found",e)}}}return{}}();if(void 0!==n.groups)for(let[e,t]of Object.entries(n.groups))y.insertChild(e,{applyHandler:()=>k(t)})}n();new MutationObserver(e=>{let t=!1;for(const n of e)for(const e of n.addedNodes)if(e instanceof HTMLElement&&"LI"===e.tagName&&e.classList.contains("tool__lib-comment")){t=!0;break}t&&n()}).observe(e,{childList:!0})}(e)}const o=document.querySelector(e);let r;o&&n(o),r=new MutationObserver(t=>{for(const o of t)for(const t of o.addedNodes){if(!(t instanceof HTMLElement))continue;const o=t.matches(e)?t:t.querySelector(e);o&&n(o)}}),r.observe(document.body,{childList:!0,subtree:!0})}();const b=/\\phantom\{([a-zA-Z0-9]+)\}/,y=new p;async function _(e,t=h(),n=g()){console.log("Auto-apply comment",e),function(e,t,n){const o=e.getBoundingClientRect(),r=o.left+o.width/2,i=o.top+o.height/2;f("mousedown",r,i,e);for(let e=1;e<=20;e++)f("mousemove",r+e/20*(t-r),i+e/20*(n-i));f("mouseup",t,n,document.elementFromPoint(t,n))}(e,t,n);const o=x[x.length-1],r=await async function(e,t=h(),n=g()){let o=0;for(;;){const r=document.elementsFromPoint(t,n).find(e);if(r)return r;if(o++,o>=100)throw new Error("Could not find element");await new Promise(e=>setTimeout(e,50))}}(e=>e.classList.contains("comment__preview-container"),t+10,n+10);return o.push(r),r}async function k(e){console.log("Apply group ",e);let t=h(),n=g();for(const o of e){const e=y.get(o);if(null==e?.rawElement){console.warn("missing comment",o);continue}const r=await _(e.rawElement,t,n);null==r?(console.warn("can't find applied comment"),n+=30):n+=r.getBoundingClientRect().height+5}}let x=[];window.addEventListener("urlchange",()=>{x=[]});const E="cmt_config:";function C(){const e=document.elementsFromPoint(h(),g());for(const t of e){const e=t.closest("div.comment__preview");if(null!=e)return e}return null}async function L(e){!function(e){const t=e.getBoundingClientRect(),n=t.x+t.width/2,o=t.y+t.height/2;f("mousedown",n,o,e),f("mouseup",n,o,e),f("click",n,o,e)}(e),(await async function(e,t){return new Promise(n=>{const o=new MutationObserver(e=>{for(const r of e)for(const e of r.addedNodes)if(e instanceof HTMLElement&&t(e))return o.disconnect(),void n(e)});o.observe(e,{childList:!0,subtree:!0})})}(e.parentElement,e=>"BUTTON"==e.tagName&&"Delete"==e.textContent.trim()&&null!=e.closest(".comment__footer"))).click()}s("w","cmt-waiting-for-comment-idx",y.createKeybindHandler(e=>{x.push([]),e.applyHandler()}),()=>{const e=document.elementFromPoint(h(),g());return null!==e?.closest(".grading-canvas__image-capture-container")},e=>{if(e){if(""==v.textContent.trim())for(const e of Array.from(document.querySelectorAll(".cm-tweaks-search-matches")))e.classList.remove("cm-tweaks-search-matches");v.textContent=e,document.documentElement.classList.add("cm-tweaks-comment-search"),y.visit((t,n)=>{const o=n.rawElement;o&&t.startsWith(e)&&o.classList.add("cm-tweaks-search-matches")})}else v.textContent="",document.documentElement.classList.remove("cm-tweaks-comment-search")}),c("x",()=>{const e=C();null!=e&&L(e)},()=>null!=C()),c("u",async()=>{const e=x.pop();for(const t of e)await L(t)},()=>x.length>0);let S=null;c(";",async()=>{const e=document.elementsFromPoint(h(),g()).filter(e=>"DIV"===e.tagName&&e.classList.contains("grading-canvas__image-capture-container"));if(0==e.length)return void console.warn("cannot find image under mouse");const t=e[0].querySelector("img.cm__lazy-img__img");null!=S&&S.abort(),S=new AbortController,console.log("Starting AI transcription");const n=function(){let e=document.querySelector("#cmt-ai-assist-popover");return null==e&&(e=document.createElement("div"),e.id="cmt-ai-assist-popover",document.querySelector("section.grading-canvas").appendChild(e)),e}();n.innerHTML="Processing...",GM_xmlhttpRequest({method:"POST",url:"http://localhost:3000/vision",headers:{"Content-Type":"application/json"},data:JSON.stringify({imageUrl:t.src}),responseType:"stream",onerror:function(e){console.error("Error while trying to transcribe",e)},onloadstart:async function(e){!async function(e,t){console.log("waiting for streamed data");const n=t.response.getReader(),o=new TextDecoder;let r;e.innerHTML="";let i="";function a(){r=document.createElement("p"),e.appendChild(r),i=""}for(a();;){const{value:e,done:t}=await n.read();if(t)break;const c=o.decode(e,{stream:!0});for(const e of c.split("\n").filter(Boolean))try{const t=JSON.parse(e);if(t.response)for(const e of t.response)"\n"===e?(a(),i=""):(i+=e,r.textContent=i,MathJax.Hub.Queue(["Typeset",MathJax.Hub,r]))}catch(e){console.warn(e)}}console.log("--- Stream complete ---")}(n,e)}})}),n(244),unsafeWindow.requireModule("ember").default;const N=document.createElement("div");N.classList.add("cm-tweaks-prefetched-image-holder"),document.body.appendChild(N),GM_addStyle("li.tool__lib-comment,span.lib-comment__text>div.processed-text{--us-height-override: 30px;height:var(--us-height-override) !important;line-height:var(--us-height-override) !important}.grading-toolbar__submenu--library{width:236px}.cmt-waiting-for-digit .grading-sidebar__evaluation .evaluation__score-block{border-color:red}.cm-tweaks-comment-macro-indicator-container{display:none}.cmt-waiting-for-comment-idx .cm-tweaks-comment-macro-indicator-container{display:flex}.cm-tweaks-comment-macro-indicator-container{position:absolute;right:4px;bottom:50%;transform:translateY(50%)}.cm-tweaks-comment-macro-indicator{display:block;padding:1px;margin:0 2px;line-height:normal !important;background-color:#ccc;border:1px #777 solid}[data-darkreader-scheme=dark] .cm-tweaks-comment-macro-indicator{background-color:#444}.cmt-grading-timer{background-color:#000;font-family:monospace;color:green;font-size:24px;text-align:center}.cmt-grading-timer.cmt-grading-timer-lagging{color:red}.cmt-comment-virtualization-workaround{resize:both;position:absolute;top:56px;left:0;display:flex;flex-direction:column}.cmt-comment-virtualization-workaround>.grading-toolbar__submenu--library{resize:none;height:initial !important;position:static;width:100% !important;flex:1 0 auto;border-radius:0}.cmt-comment-virtualization-workaround{width:236px;overflow-y:auto;overflow-x:hidden;border:2px rgba(0,0,0,0) solid;border-radius:4px}.cmt-waiting-for-comment-idx .cmt-comment-virtualization-workaround{border-color:red}.cm-tweaks-comment-search li.tool__lib-comment:not(.cm-tweaks-search-matches){display:none}#cmt-ai-assist-popover{position:fixed;right:240px;top:5rem;background-color:#222;color:#fff;border-radius:1rem;width:600px;height:400px;z-index:1000;overflow-y:auto;padding:1em;font-size:14px}#cmt-ai-assist-popover p{margin-bottom:.5em}.cm-comment.is-editing{z-index:100}.cm-tweaks-fast-grading-switch-enabled .grading-canvas__container>.grading-canvas__item:not(.is-active){display:none}.cm-tweaks-prefetched-image-holder{position:absolute;top:0;left:0;z-index:0;visibility:hidden;pointer-events:none}.cm-tweaks-search-visual{position:absolute;top:.5em;right:.5em;display:none}.cmt-waiting-for-comment-idx .cm-tweaks-search-visual{display:block}.cm-tweaks-search-visual{color:#fff;font-weight:bold}[data-darkreader-scheme=dark] .cm-tweaks-search-visual{background-color:#444}"),function(){let e=0;s("a","cmt-waiting-for-digit",t=>{const n=parseInt(t,10);isNaN(n)||(e=n,l(n))}),c("u",()=>{e>0&&(l(-e),e=0)}),c("d",()=>{l(-1)})}(),function(){let e,n,r=0,i=t();function a(){const t=document.querySelector(".grading-sidebar__container > .evaluation__list");if(!t||t.parentElement.querySelector(".cmt-grading-timer"))return;const o=document.createElement("div");o.classList.add("cmt-grading-timer"),o.textContent="00:00",t.parentElement.appendChild(o),n=o,e&&e.disconnect()}function s(e){r=e,n.textContent=function(e){const t=e<0?"-":"";e=Math.abs(e);const n=Math.floor(e/60),o=Math.floor(e%60);return`${t}${n.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}(e),e<d()?n.classList.remove("cmt-grading-timer-lagging"):n.classList.add("cmt-grading-timer-lagging")}a(),e=new MutationObserver(()=>a()),e.observe(document.body,{childList:!0,subtree:!0});let l,m=o()??-1;function u(){null!=n&&i&&s(r+1)}function f(){null!=l&&(h(),g())}function h(){null!=l&&(clearInterval(l),l=null)}function g(){null==l&&(l=setInterval(u,1e3))}window.addEventListener("urlchange",()=>{const e=i;i=t();const n=o();null==n||m>=n||(m=n,e&&s(r-d()),f())}),c("\\",()=>{s(0),f()}),document.hidden||g(),document.addEventListener("visibilitychange",()=>{document.hidden?h():g()})}()})()})();