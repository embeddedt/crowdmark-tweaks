// ==UserScript==
// @name Crowdmark Tweaks
// @description Useful tweaks for Crowdmark
// @version 0.1.0-build.2025-10-11T23:59:27.766Z
// @author embeddedt
// @homepage https://github.com/embeddedt/crowdmark-tweaks
// @supportURL https://github.com/embeddedt/crowdmark-tweaks/issues
// @match https://app.crowdmark.com/*
// @connect app.crowdmark.com
// @connect localhost
// @downloadURL https://github.com/embeddedt/crowdmark-tweaks/raw/refs/heads/main/crowdmark-tweaks.user.js
// @grant GM_addStyle
// @grant GM_addElement
// @grant GM_xmlhttpRequest
// @icon https://www.google.com/s2/favicons?sz=64&domain=crowdmark.com
// @namespace https://github.com/embeddedt
// @updateURL https://github.com/embeddedt/crowdmark-tweaks/raw/refs/heads/main/crowdmark-tweaks.meta.js
// ==/UserScript==

(()=>{"use strict";const t=/^https:\/\/app\.crowdmark\.com\/exams\/([^/]+)\/grading\/student\/(\d+)/;function o(){return null!=window.location.href.match(t)}function n(){const o=window.location.href.match(t);return o?parseInt(o[2]):null}!function(){const t=history.pushState,o=history.replaceState;let n=location.href;function e(){const t=location.href;t!==n&&(n=t,function(){const t=new CustomEvent("urlchange",{detail:{url:location.href}});window.dispatchEvent(t)}())}history.pushState=function(...o){t.apply(this,o),e()},history.replaceState=function(...t){o.apply(this,t),e()},window.addEventListener("popstate",e)}();let e=new Set;function i(t){let o=e.size;return e.has(t)&&o--,o>0}function r(t){const o=t.target;return"INPUT"!==o.tagName&&"TEXTAREA"!==o.tagName&&!o.isContentEditable}function c(t,o){document.addEventListener("keydown",n=>{!r(n)||n.repeat||i(t)||n.key.toLowerCase()===t&&(n.stopImmediatePropagation(),n.preventDefault(),setTimeout(()=>o(),0))})}function l(t,o,n,c){const l=document.documentElement;let a="";function s(){l.classList.remove(o),e.delete(t),a=""}document.addEventListener("keydown",m=>{if(!r(m)||i(t)||c&&!c())return;const u=l.classList.contains(o),d=m.key.toLowerCase();if(u)if(1!==d.length||m.ctrlKey||m.altKey||m.metaKey||m.shiftKey)"escape"===d&&s();else{a+=d,m.stopImmediatePropagation(),m.preventDefault();let t=!1;try{t=n(a)}catch(m){console.error("Error from keybind handler",m)}t||s()}else d===t&&(l.classList.add(o),e.add(t))})}function a(t){!function(t){if(t<0)return void console.error("refusing to enter negative grade");const o=function(){const t=document.querySelector(".evaluation__keypad"),o=Array.from(t.children).filter(t=>"BUTTON"===t.tagName),n=new Map;return o.forEach(t=>{const o=t.textContent.trim();o&&n.set(o,t)}),n}(),n=o.get("CLR");if(null==n)return void console.error("Can't find clear button");const e=[];for(;t>0;)e.unshift(t%10),t=Math.floor(t/10);n.click();for(let t of e){const n=o.get(t.toString());null==n?console.warn("Cannot find grading keypad button for",t):n.click()}}(function(){const t=document.querySelector(".evaluation__points");if(null==t)throw new Error("can't find current grade");let o=parseInt(t.textContent.trim(),10);return isNaN(o)&&(o=0),o}()+t)}function s(){return window.localStorage.getItem("cmtSecondsPerBooklet")??50}let m=0,u=0;function d(){return m}function p(){return u}document.addEventListener("mousemove",t=>{m=t.clientX,u=t.clientY}),function(){const t="ul.grading-toolbar__submenu.grading-toolbar__submenu--library",o="cmt-comment-virtualization-workaround";function n(t){if(!t||t.parentElement?.classList.contains(o))return;const n=document.createElement("div");n.className=o,t.replaceWith(n),n.appendChild(t)}const e=document.querySelector(t);let i;e&&n(e),i=new MutationObserver(o=>{for(const e of o)for(const o of e.addedNodes){if(!(o instanceof HTMLElement))continue;const e=o.matches(t)?o:o.querySelector(t);e&&n(e)}}),i.observe(document.body,{childList:!0,subtree:!0})}();const g="cmt_config:";var f,b;l("w","cmt-waiting-for-comment-idx",(f=function(){const t=new Map,o=new Map;function n(t,o=d(),n=p()){console.log("Auto-apply comment",t),function(t,o,n){const e=t.getBoundingClientRect(),i=e.left+e.width/2,r=e.top+e.height/2;function c(t,o,n,e=document.elementFromPoint(o,n)){if(!e)return void console.warn("can't find target to fire "+t+" event to");const i=new MouseEvent(t,{bubbles:!0,cancelable:!0,clientX:o,clientY:n,buttons:1});e.dispatchEvent(i)}c("mousedown",i,r,t);for(let t=1;t<=20;t++)c("mousemove",i+t/20*(o-i),r+t/20*(n-r));c("mouseup",o,n,document.elementFromPoint(o,n))}(t,o,n)}const e=document.querySelector("ul.grading-toolbar__submenu--library");if(e){const i=Array.from(e.querySelectorAll("li.tool__lib-comment:not(.lib-comment--no-comment)"));for(let e=0;e<i.length;e++){const r=i[e],c=r.querySelector("span:nth-child(1 of .MathJax) mphantom");if(null!=c){const e=c.textContent.trim();t.has(e)||(o.set(e,r),t.set(e,()=>n(r)))}if(e<10){const i=((e+1)%10).toString();o.set(i,r),t.set(i,()=>n(r))}}}function i(t){console.log("Apply group ",t);let e=d(),i=p();for(const r of t){const t=o.get(r);if(null==t){console.warn("missing comment",r);continue}n(t,e,i);const c=document.elementFromPoint(e+5,i+5)?.closest(".comment__preview-container");null==c?(console.warn("can't find applied comment"),i+=30):i+=c.getBoundingClientRect().height+5}}const r=function(){const t=document.querySelector("ul.grading-toolbar__submenu--library");if(t){const o=Array.from(t.querySelectorAll("li.tool__lib-comment:not(.lib-comment--no-comment)"));for(let t of o){const o=t.querySelector(".lib-comment__text")?.textContent.trim()??"";if(o.startsWith(g))try{return JSON.parse(o.substring(11))}catch(t){console.error("Invalid CMT config found",t)}}}return{}}();if(void 0!==r.groups)for(let[o,n]of Object.entries(r.groups))t.set(o,()=>i(n));return t},b=t=>t(),t=>{const o=function(t,o){let n=null,e=0;for(const[i,r]of t)if(i.startsWith(o)){if(e++,e>1)return{status:"conflict"};n=r}return null!=n?{status:"unique",value:n}:{status:"none"}}(f(),t);return"none"==o.status?(console.warn("no matching value found"),!1):"conflict"==o.status||(b(o.value),!1)}),()=>{const t=document.elementFromPoint(d(),p());return null!==t?.closest(".grading-canvas__image-capture-container")});let h=null;c(";",async()=>{const t=document.elementsFromPoint(d(),p()).filter(t=>"DIV"===t.tagName&&t.classList.contains("grading-canvas__image-capture-container"));if(0==t.length)return void console.warn("cannot find image under mouse");const o=t[0].querySelector("img.cm__lazy-img__img");null!=h&&h.abort(),h=new AbortController,console.log("Starting AI transcription");const n=function(){let t=document.querySelector("#cmt-ai-assist-popover");return null==t&&(t=document.createElement("div"),t.id="cmt-ai-assist-popover",document.querySelector("section.grading-canvas").appendChild(t)),t}();n.innerHTML="Processing...",GM_xmlhttpRequest({method:"POST",url:"http://localhost:3000/vision",headers:{"Content-Type":"application/json"},data:JSON.stringify({imageUrl:o.src}),responseType:"stream",onerror:function(t){console.error("Error while trying to transcribe",t)},onloadstart:async function(t){!async function(t,o){console.log("waiting for streamed data");const n=o.response.getReader(),e=new TextDecoder;let i;t.innerHTML="";let r="";function c(){i=document.createElement("p"),t.appendChild(i),r=""}for(c();;){const{value:t,done:o}=await n.read();if(o)break;const l=e.decode(t,{stream:!0});for(const t of l.split("\n").filter(Boolean))try{const o=JSON.parse(t);if(o.response)for(const t of o.response)"\n"===t?(c(),r=""):(r+=t,i.textContent=r,MathJax.Hub.Queue(["Typeset",MathJax.Hub,i]))}catch(t){console.warn(t)}}console.log("--- Stream complete ---")}(n,t)}})}),GM_addStyle('li.tool__lib-comment,span.lib-comment__text>div.processed-text{--us-height-override: 30px;height:var(--us-height-override) !important;line-height:var(--us-height-override) !important}.grading-toolbar__submenu--library{width:236px}.cmt-waiting-for-digit .grading-sidebar__evaluation .evaluation__score-block{border-color:red}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(1)::before{display:block;content:"0";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(2)::before{display:block;content:"1";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(3)::before{display:block;content:"2";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(4)::before{display:block;content:"3";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(5)::before{display:block;content:"4";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(6)::before{display:block;content:"5";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(7)::before{display:block;content:"6";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(8)::before{display:block;content:"7";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(9)::before{display:block;content:"8";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}.cmt-grading-timer{background-color:#000;font-family:monospace;color:green;font-size:24px;text-align:center}.cmt-grading-timer.cmt-grading-timer-lagging{color:red}.cmt-comment-virtualization-workaround{resize:both;position:absolute;top:56px;left:0}.cmt-comment-virtualization-workaround>.grading-toolbar__submenu--library{resize:none;height:initial !important;position:absolute;top:0;left:0;width:100% !important}.cmt-comment-virtualization-workaround{width:236px;height:500px;overflow-y:auto;overflow-x:hidden;border:2px rgba(0,0,0,0) solid}.cmt-waiting-for-comment-idx .cmt-comment-virtualization-workaround{border-color:red}#cmt-ai-assist-popover{position:fixed;right:240px;top:5rem;background-color:#222;color:#fff;border-radius:1rem;width:600px;height:400px;z-index:1000;overflow-y:auto;padding:1em;font-size:14px}#cmt-ai-assist-popover p{margin-bottom:.5em}'),function(){let t=0;l("a","cmt-waiting-for-digit",o=>{const n=parseInt(o,10);isNaN(n)||(t=n,a(n))}),c("u",()=>{t>0&&(a(-t),t=0)}),c("d",()=>{a(-1)})}(),function(){let t,e,i=0,r=o();function l(){const o=document.querySelector(".grading-sidebar__container > .evaluation__list");if(!o||o.parentElement.querySelector(".cmt-grading-timer"))return;const n=document.createElement("div");n.classList.add("cmt-grading-timer"),n.textContent="00:00",o.parentElement.appendChild(n),e=n,t&&t.disconnect()}function a(t){i=t,e.textContent=function(t){const o=t<0?"-":"";t=Math.abs(t);const n=Math.floor(t/60),e=Math.floor(t%60);return`${o}${n.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`}(t),t<s()?e.classList.remove("cmt-grading-timer-lagging"):e.classList.add("cmt-grading-timer-lagging")}l(),t=new MutationObserver(()=>l()),t.observe(document.body,{childList:!0,subtree:!0});let m,u=n()??-1;function d(){null!=e&&r&&a(i+1)}function p(){null!=m&&(g(),f())}function g(){null!=m&&(clearInterval(m),m=null)}function f(){null==m&&(m=setInterval(d,1e3))}window.addEventListener("urlchange",()=>{const t=r;r=o();const e=n();null==e||u>=e||(u=e,t&&a(i-s()),p())}),c("\\",()=>{a(0),p()}),document.hidden||f(),document.addEventListener("visibilitychange",()=>{document.hidden?g():f()})}()})();