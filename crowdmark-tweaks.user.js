// ==UserScript==
// @name Crowdmark Tweaks
// @description Useful tweaks for Crowdmark
// @version 0.1.0-build.2025-11-15T16:04:22.934Z
// @author embeddedt
// @homepage https://github.com/embeddedt/crowdmark-tweaks
// @supportURL https://github.com/embeddedt/crowdmark-tweaks/issues
// @match https://app.crowdmark.com/*
// @connect app.crowdmark.com
// @connect localhost
// @downloadURL https://github.com/embeddedt/crowdmark-tweaks/raw/refs/heads/main/crowdmark-tweaks.user.js
// @grant GM_addStyle
// @grant GM_addElement
// @grant GM_xmlhttpRequest
// @grant window.onurlchange
// @icon https://www.google.com/s2/favicons?sz=64&domain=crowdmark.com
// @namespace https://github.com/embeddedt
// @run-at document-idle
// @updateURL https://github.com/embeddedt/crowdmark-tweaks/raw/refs/heads/main/crowdmark-tweaks.meta.js
// ==/UserScript==

/*! For license information please see crowdmark-tweaks.js.LICENSE.txt */
(()=>{"use strict";var t=/^https:\/\/app\.crowdmark\.com\/exams\/([^/]+)\/grading\/student\/(\d+)\/question\/([^/]+)/;function e(){return null!=window.location.href.match(t)}function n(){var e=window.location.href.match(t);return e?parseInt(e[2]):null}!function(){var t=history.pushState,e=history.replaceState,n=location.href;function r(){var t,e=location.href;e!==n&&(n=e,t=new CustomEvent("urlchange",{detail:{url:location.href}}),window.dispatchEvent(t))}history.pushState=function(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];t.apply(this,n),r()},history.replaceState=function(){for(var t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];e.apply(this,n),r()},window.addEventListener("popstate",r)}();var r=new Set;function o(t){var e=r.size;return r.has(t)&&e--,e>0}function i(t){var e=t.target;return"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&!e.isContentEditable}var a=new Map;function c(t){var e=window.localStorage.getItem("CMT-KEYBIND:"+t);return null==e&&(e=a.get(t)),e}function l(t,e,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){return!0};a.set(t,e),document.addEventListener("keydown",function(e){var a=c(t);i(e)&&!e.repeat&&!o(a)&&r()&&e.key.toLowerCase()===a&&(e.stopImmediatePropagation(),e.preventDefault(),setTimeout(function(){return n()},0))})}function u(t,e,n,l,u,s){s||(s=function(){}),a.set(t,e);var f=document.documentElement,_="";function d(){f.classList.remove(n),r.delete(c(t)),_="",s(null)}document.addEventListener("keydown",function(e){var a=c(t);if(i(e)&&!o(a)&&(!u||u())){var m=f.classList.contains(n),p=e.key.toLowerCase();if(m)if(1!==p.length||e.ctrlKey||e.altKey||e.metaKey||e.shiftKey)"escape"===p&&d();else{_+=p,e.stopImmediatePropagation(),e.preventDefault();var h=!1;try{h=l(_)}catch(e){console.error("Error from keybind handler",e)}h?s(_):d()}else p===a&&(f.classList.add(n),r.add(a),s(""))}})}function s(t){!function(t){if(t<0)console.error("refusing to enter negative grade");else{var e,n,r,o=(e=document.querySelector(".evaluation__keypad"),n=Array.from(e.children).filter(function(t){return"BUTTON"===t.tagName}),r=new Map,n.forEach(function(t){var e=t.textContent.trim();e&&r.set(e,t)}),r),i=o.get("CLR");if(null!=i){for(var a=[];t>0;)a.unshift(t%10),t=Math.floor(t/10);i.click();for(var c=0,l=a;c<l.length;c++){var u=l[c],s=o.get(u.toString());null==s?console.warn("Cannot find grading keypad button for",u):s.click()}}else console.error("Can't find clear button")}}(function(){var t=document.querySelector(".evaluation__points");if(null==t)throw new Error("can't find current grade");var e=parseInt(t.textContent.trim(),10);return isNaN(e)&&(e=0),e}()+t)}const f=["Pacing timer","Hide questions not being graded"],_=new Map;function d(t){if(!f.includes(t))throw new Error("Unexpected feature flag name: "+t);const e=window.localStorage.getItem("CMT-FEATURE:"+t);return null==e||"true"===e}function m(){var t;return null!==(t=window.localStorage.getItem("cmtSecondsPerBooklet"))&&void 0!==t?t:50}function p(){var t,e,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof c?r:c,u=Object.create(l.prototype);return h(u,"_invoke",function(n,r,o){var i,c,l,u=0,s=o||[],f=!1,_={p:0,n:0,v:t,a:d,f:d.bind(t,4),d:function(e,n){return i=e,c=0,l=t,_.n=n,a}};function d(n,r){for(c=n,l=r,e=0;!f&&u&&!o&&e<s.length;e++){var o,i=s[e],d=_.p,m=i[2];n>3?(o=m===r)&&(l=i[(c=i[4])?5:(c=3,3)],i[4]=i[5]=t):i[0]<=d&&((o=n<2&&d<i[1])?(c=0,_.v=r,_.n=i[1]):d<m&&(o=n<3||i[0]>r||r>m)&&(i[4]=n,i[5]=r,_.n=m,c=0))}if(o||n>1)return a;throw f=!0,r}return function(o,s,m){if(u>1)throw TypeError("Generator is already running");for(f&&1===s&&d(s,m),c=s,l=m;(e=c<2?t:l)||!f;){i||(c?c<3?(c>1&&(_.n=-1),d(c,l)):_.n=l:_.v=l);try{if(u=2,i){if(c||(o="next"),e=i[o]){if(!(e=e.call(i,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,c<2&&(c=0)}else 1===c&&(e=i.return)&&e.call(i),c<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),c=1);i=t}else if((e=(f=_.n<0)?l:n.call(r,_))!==a)break}catch(e){i=t,c=1,l=e}finally{u=1}}return{value:e,done:f}}}(n,o,i),!0),u}var a={};function c(){}function l(){}function u(){}e=Object.getPrototypeOf;var s=[][r]?e(e([][r]())):(h(e={},r,function(){return this}),e),f=u.prototype=c.prototype=Object.create(s);function _(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,u):(t.__proto__=u,h(t,o,"GeneratorFunction")),t.prototype=Object.create(f),t}return l.prototype=u,h(f,"constructor",u),h(u,"constructor",l),l.displayName="GeneratorFunction",h(u,o,"GeneratorFunction"),h(f),h(f,o,"Generator"),h(f,r,function(){return this}),h(f,"toString",function(){return"[object Generator]"}),(p=function(){return{w:i,m:_}})()}function h(t,e,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(t){o=0}h=function(t,e,n,r){function i(e,n){h(t,e,function(t){return this._invoke(e,n,t)})}e?o?o(t,e,{value:n,enumerable:!r,configurable:!r,writable:!r}):t[e]=n:(i("next",0),i("throw",1),i("return",2))},h(t,e,n,r)}function v(t,e,n,r,o,i,a){try{var c=t[i](a),l=c.value}catch(t){return void n(t)}c.done?e(l):Promise.resolve(l).then(r,o)}var g=0,y=0;function b(t,e,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:document.elementFromPoint(e,n);if(r){var o=new MouseEvent(t,{bubbles:!0,cancelable:!0,clientX:e,clientY:n,buttons:1});r.dispatchEvent(o)}else console.warn("can't find target to fire "+t+" event to")}function w(){return g}function k(){return y}function E(){return E=function(t){return function(){var e=this,n=arguments;return new Promise(function(r,o){var i=t.apply(e,n);function a(t){v(i,r,o,a,c,"next",t)}function c(t){v(i,r,o,a,c,"throw",t)}a(void 0)})}}(p().m(function t(e){var n,r,o,i,a=arguments;return p().w(function(t){for(;;)switch(t.n){case 0:n=a.length>1&&void 0!==a[1]?a[1]:w(),r=a.length>2&&void 0!==a[2]?a[2]:k(),o=0;case 1:if(!(i=document.elementsFromPoint(n,r).find(e))){t.n=2;break}return t.a(2,i);case 2:if(!(++o>=100)){t.n=3;break}throw new Error("Could not find element");case 3:return t.n=4,new Promise(function(t){return setTimeout(t,50)});case 4:t.n=1;break;case 5:return t.a(2)}},t)})),E.apply(this,arguments)}function x(){var t,e,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof c?r:c,u=Object.create(l.prototype);return S(u,"_invoke",function(n,r,o){var i,c,l,u=0,s=o||[],f=!1,_={p:0,n:0,v:t,a:d,f:d.bind(t,4),d:function(e,n){return i=e,c=0,l=t,_.n=n,a}};function d(n,r){for(c=n,l=r,e=0;!f&&u&&!o&&e<s.length;e++){var o,i=s[e],d=_.p,m=i[2];n>3?(o=m===r)&&(l=i[(c=i[4])?5:(c=3,3)],i[4]=i[5]=t):i[0]<=d&&((o=n<2&&d<i[1])?(c=0,_.v=r,_.n=i[1]):d<m&&(o=n<3||i[0]>r||r>m)&&(i[4]=n,i[5]=r,_.n=m,c=0))}if(o||n>1)return a;throw f=!0,r}return function(o,s,m){if(u>1)throw TypeError("Generator is already running");for(f&&1===s&&d(s,m),c=s,l=m;(e=c<2?t:l)||!f;){i||(c?c<3?(c>1&&(_.n=-1),d(c,l)):_.n=l:_.v=l);try{if(u=2,i){if(c||(o="next"),e=i[o]){if(!(e=e.call(i,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,c<2&&(c=0)}else 1===c&&(e=i.return)&&e.call(i),c<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),c=1);i=t}else if((e=(f=_.n<0)?l:n.call(r,_))!==a)break}catch(e){i=t,c=1,l=e}finally{u=1}}return{value:e,done:f}}}(n,o,i),!0),u}var a={};function c(){}function l(){}function u(){}e=Object.getPrototypeOf;var s=[][r]?e(e([][r]())):(S(e={},r,function(){return this}),e),f=u.prototype=c.prototype=Object.create(s);function _(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,u):(t.__proto__=u,S(t,o,"GeneratorFunction")),t.prototype=Object.create(f),t}return l.prototype=u,S(f,"constructor",u),S(u,"constructor",l),l.displayName="GeneratorFunction",S(u,o,"GeneratorFunction"),S(f),S(f,o,"Generator"),S(f,r,function(){return this}),S(f,"toString",function(){return"[object Generator]"}),(x=function(){return{w:i,m:_}})()}function S(t,e,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(t){o=0}S=function(t,e,n,r){function i(e,n){S(t,e,function(t){return this._invoke(e,n,t)})}e?o?o(t,e,{value:n,enumerable:!r,configurable:!r,writable:!r}):t[e]=n:(i("next",0),i("throw",1),i("return",2))},S(t,e,n,r)}function C(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return T(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?T(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,o=function(){};return{s:o,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,c=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){c=!0,i=t},f:function(){try{a||null==n.return||n.return()}finally{if(c)throw i}}}}function T(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function N(t,e,n,r,o,i,a){try{var c=t[i](a),l=c.value}catch(t){return void n(t)}c.done?e(l):Promise.resolve(l).then(r,o)}function A(){return A=function(t){return function(){var e=this,n=arguments;return new Promise(function(r,o){var i=t.apply(e,n);function a(t){N(i,r,o,a,c,"next",t)}function c(t){N(i,r,o,a,c,"throw",t)}a(void 0)})}}(x().m(function t(e,n){return x().w(function(t){for(;;)if(0===t.n)return t.a(2,new Promise(function(t){var r=new MutationObserver(function(e){var o,i=C(e);try{for(i.s();!(o=i.n()).done;){var a,c=C(o.value.addedNodes);try{for(c.s();!(a=c.n()).done;){var l=a.value;if(l instanceof HTMLElement&&n(l))return r.disconnect(),void t(l)}}catch(t){c.e(t)}finally{c.f()}}}catch(t){i.e(t)}finally{i.f()}});r.observe(e,{childList:!0,subtree:!0})}))},t)})),A.apply(this,arguments)}document.addEventListener("mousemove",function(t){g=t.clientX,y=t.clientY});class L{element;children;usages;constructor(){this.clear()}insertChild(t,e){const n=this.getNestedTrieForPrefix(t);null==n?this._insertChild(t,0,e):n.element=e}_insertChild(t,e,n){if(this.usages++,e==t.length){if(null!=this.element)throw new Error("Multiple attempts to insert to the same node");return void(this.element=n)}this.children||(this.children=new Map);const r=t.charAt(e);let o;this.children.has(r)?o=this.children.get(r):(o=new L,this.children.set(r,o)),o._insertChild(t,e+1,n)}visit(t){if(this.element)t("",this.element);else if(null!=this.children)for(const[e,n]of this.children.entries())n.visit((n,r)=>{t(e+n,r)})}forEachValue(t){if(this.element)t(this.element);else if(null!=this.children)for(const e of this.children.values())e.forEachValue(t)}getNestedTrieForPrefix(t){return this._getNestedTrieForChar(t,0)}_getNestedTrieForChar(t,e){if(e==t.length)return this;if(null!=this.children){const n=t.charAt(e),r=this.children.get(n);if(r)return r._getNestedTrieForChar(t,e+1)}return null}get(t){const e=this.getNestedTrieForPrefix(t);return e?.element??null}clear(){this.usages=0,this.element=null,this.children=null}_getUniqueContainedElement(){if(null!=this.element)return this.element;if(this.children&&1==this.children.size)return[...this.children.values()][0]._getUniqueContainedElement();throw new Error("Contained element not found")}createKeybindHandler(t){return e=>{const n=this.getNestedTrieForPrefix(e);return null==n||0==n.usages?(console.warn("no matching value found"),!1):n.usages>1||(t(n._getUniqueContainedElement()),!1)}}size(){return this.usages}toString(){const t=[];return this.visit((e,n)=>{t.push(e+" -> "+n)}),"Trie{"+t.join(", ")+"}"}}let P=null,O=null;!function(){const t="ul.grading-toolbar__submenu.grading-toolbar__submenu--library",e="cmt-comment-virtualization-workaround";function n(t){if(!t||t.parentElement?.classList.contains(e))return;const n=document.createElement("div");n.className=e,t.replaceWith(n),n.appendChild(t),O=document.createElement("span"),O.classList.add("cm-tweaks-search-visual"),n.appendChild(O),P=n,function(t){function e(e){if(e.classList.contains("cm-tweaks-macro-comment"))return;let n=0,r=[];const o=e.textContent.match(M);o&&r.push(o[1]);for(const o of t.children){if("LI"===o.tagName&&o.classList.contains("tool__lib-comment")&&n++,n>10)break;if(n>=1&&o===e){const t=n.toString();r.includes(t)||r.push(t);break}}if(r.length>0){const t=document.createElement("div");t.classList.add("cm-tweaks-comment-macro-indicator-container"),e.insertBefore(t,e.firstChild);for(const n of r){const r=document.createElement("span");r.textContent=n,r.classList.add("cm-tweaks-comment-macro-indicator"),t.appendChild(r),I.insertChild(n,{rawElement:e,applyHandler:()=>j(e)})}}}function n(){for(const e of Array.from(t.querySelectorAll(".cm-tweaks-comment-macro-indicator")))e.parentNode.removeChild(e);I.clear();for(const n of t.querySelectorAll("li.tool__lib-comment:not(.lib-comment--loading)"))"LI"===n.tagName&&e(n);const n=function(){const t=document.querySelector("ul.grading-toolbar__submenu--library");if(t){const e=Array.from(t.querySelectorAll("li.tool__lib-comment:not(.lib-comment--no-comment)"));for(let t of e){const e=t.querySelector(".lib-comment__text")?.textContent.trim()??"";if(e.startsWith(U))try{return JSON.parse(e.substring(U.length))}catch(t){console.error("Invalid CMT config found",t)}}}return{}}();if(void 0!==n.groups)for(let[t,e]of Object.entries(n.groups))I.insertChild(t,{applyHandler:()=>H(e)})}n();new MutationObserver(t=>{let e=!1;for(const n of t)for(const t of n.addedNodes)if(t instanceof HTMLElement&&"LI"===t.tagName&&t.classList.contains("tool__lib-comment")){e=!0;break}e&&n()}).observe(t,{childList:!0})}(t)}const r=document.querySelector(t);let o;r&&n(r),o=new MutationObserver(e=>{for(const r of e)for(const e of r.addedNodes){if(!(e instanceof HTMLElement))continue;const r=e.matches(t)?e:e.querySelector(t);r&&n(r)}}),o.observe(document.body,{childList:!0,subtree:!0})}();const M=/\\phantom\{([a-zA-Z0-9]+)\}/,I=new L;async function j(t,e=w(),n=k()){console.log("Auto-apply comment",t),function(t,e,n){var r=t.getBoundingClientRect(),o=r.left+r.width/2,i=r.top+r.height/2;b("mousedown",o,i,t);for(var a=1;a<=20;a++)b("mousemove",o+a/20*(e-o),i+a/20*(n-i));b("mouseup",e,n,document.elementFromPoint(e,n))}(t,e,n);const r=F[F.length-1],o=await function(t){return E.apply(this,arguments)}(t=>t.classList.contains("comment__preview-container"),e+10,n+10);return r.push(o),o}async function H(t){console.log("Apply group ",t);let e=w(),n=k();for(const r of t){const t=I.get(r);if(null==t?.rawElement){console.warn("missing comment",r);continue}const o=await j(t.rawElement,e,n);null==o?(console.warn("can't find applied comment"),n+=30):n+=o.getBoundingClientRect().height+5}}let F=[];window.addEventListener("urlchange",()=>{F=[]});const U="cmt_config:";function q(){const t=document.elementsFromPoint(w(),k());for(const e of t){const t=e.closest("div.comment__preview");if(null!=t)return t}return null}async function D(t){!function(t){var e=t.getBoundingClientRect(),n=e.x+e.width/2,r=e.y+e.height/2;b("mousedown",n,r,t),b("mouseup",n,r,t),b("click",n,r,t)}(t);const e=await function(t,e){return A.apply(this,arguments)}(t.parentElement,t=>"BUTTON"==t.tagName&&"Delete"==t.textContent.trim()&&null!=t.closest(".comment__footer"));e.click()}function z(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return G(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?G(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,o=function(){};return{s:o,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,c=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){c=!0,i=t},f:function(){try{a||null==n.return||n.return()}finally{if(c)throw i}}}}function G(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function R(){var t,e,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof c?r:c,u=Object.create(l.prototype);return B(u,"_invoke",function(n,r,o){var i,c,l,u=0,s=o||[],f=!1,_={p:0,n:0,v:t,a:d,f:d.bind(t,4),d:function(e,n){return i=e,c=0,l=t,_.n=n,a}};function d(n,r){for(c=n,l=r,e=0;!f&&u&&!o&&e<s.length;e++){var o,i=s[e],d=_.p,m=i[2];n>3?(o=m===r)&&(l=i[(c=i[4])?5:(c=3,3)],i[4]=i[5]=t):i[0]<=d&&((o=n<2&&d<i[1])?(c=0,_.v=r,_.n=i[1]):d<m&&(o=n<3||i[0]>r||r>m)&&(i[4]=n,i[5]=r,_.n=m,c=0))}if(o||n>1)return a;throw f=!0,r}return function(o,s,m){if(u>1)throw TypeError("Generator is already running");for(f&&1===s&&d(s,m),c=s,l=m;(e=c<2?t:l)||!f;){i||(c?c<3?(c>1&&(_.n=-1),d(c,l)):_.n=l:_.v=l);try{if(u=2,i){if(c||(o="next"),e=i[o]){if(!(e=e.call(i,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,c<2&&(c=0)}else 1===c&&(e=i.return)&&e.call(i),c<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),c=1);i=t}else if((e=(f=_.n<0)?l:n.call(r,_))!==a)break}catch(e){i=t,c=1,l=e}finally{u=1}}return{value:e,done:f}}}(n,o,i),!0),u}var a={};function c(){}function l(){}function u(){}e=Object.getPrototypeOf;var s=[][r]?e(e([][r]())):(B(e={},r,function(){return this}),e),f=u.prototype=c.prototype=Object.create(s);function _(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,u):(t.__proto__=u,B(t,o,"GeneratorFunction")),t.prototype=Object.create(f),t}return l.prototype=u,B(f,"constructor",u),B(u,"constructor",l),l.displayName="GeneratorFunction",B(u,o,"GeneratorFunction"),B(f),B(f,o,"Generator"),B(f,r,function(){return this}),B(f,"toString",function(){return"[object Generator]"}),(R=function(){return{w:i,m:_}})()}function B(t,e,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(t){o=0}B=function(t,e,n,r){function i(e,n){B(t,e,function(t){return this._invoke(e,n,t)})}e?o?o(t,e,{value:n,enumerable:!r,configurable:!r,writable:!r}):t[e]=n:(i("next",0),i("throw",1),i("return",2))},B(t,e,n,r)}function W(t,e,n,r,o,i,a){try{var c=t[i](a),l=c.value}catch(t){return void n(t)}c.done?e(l):Promise.resolve(l).then(r,o)}function K(t){return function(){var e=this,n=arguments;return new Promise(function(r,o){var i=t.apply(e,n);function a(t){W(i,r,o,a,c,"next",t)}function c(t){W(i,r,o,a,c,"throw",t)}a(void 0)})}}function $(){var t=document.querySelector("#cmt-ai-assist-popover");return null==t&&((t=document.createElement("div")).id="cmt-ai-assist-popover",document.querySelector("section.grading-canvas").appendChild(t)),t}u("Enter comment macro mode","w","cmt-waiting-for-comment-idx",I.createKeybindHandler(t=>{F.push([]),t.applyHandler()}),()=>{const t=document.elementFromPoint(w(),k());return null!==t?.closest(".grading-canvas__image-capture-container")},t=>{if(t){if(""==O.textContent.trim())for(const t of Array.from(document.querySelectorAll(".cm-tweaks-search-matches")))t.classList.remove("cm-tweaks-search-matches");O.textContent=t,document.documentElement.classList.add("cm-tweaks-comment-search"),I.visit((e,n)=>{const r=n.rawElement;r&&e.startsWith(t)&&r.classList.add("cm-tweaks-search-matches")})}else O.textContent="",document.documentElement.classList.remove("cm-tweaks-comment-search")}),l("Delete comment under cursor","x",()=>{const t=q();null!=t&&D(t)},()=>null!=q()),l("Undo last comment placement","u",async()=>{const t=F.pop();for(const e of t)await D(e)},()=>F.length>0);var J,Y,V=null;function X(t,e){return Q.apply(this,arguments)}function Q(){return(Q=K(R().m(function t(e,n){var r,o,i,a,c,l,u,s,f,_,d,m,p,h,v;return R().w(function(t){for(;;)switch(t.n){case 0:c=function(){i=document.createElement("p"),e.appendChild(i),a=""},console.log("waiting for streamed data"),r=n.response.getReader(),o=new TextDecoder,e.innerHTML="",a="",c();case 1:return t.n=2,r.read();case 2:if(l=t.v,u=l.value,!l.done){t.n=3;break}return t.a(3,4);case 3:s=o.decode(u,{stream:!0}),f=z(s.split("\n").filter(Boolean));try{for(f.s();!(_=f.n()).done;){d=_.value;try{if((m=JSON.parse(d)).response){p=z(m.response);try{for(p.s();!(h=p.n()).done;)"\n"===(v=h.value)?(c(),a=""):(a+=v,i.textContent=a,MathJax.Hub.Queue(["Typeset",MathJax.Hub,i]))}catch(t){p.e(t)}finally{p.f()}}}catch(t){console.warn(t)}}}catch(t){f.e(t)}finally{f.f()}t.n=1;break;case 4:console.log("--- Stream complete ---");case 5:return t.a(2)}},t)}))).apply(this,arguments)}function Z(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return tt(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?tt(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,o=function(){};return{s:o,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,c=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){c=!0,i=t},f:function(){try{a||null==n.return||n.return()}finally{if(c)throw i}}}}function tt(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function et(){console.log("trigger image load");try{window.dispatchEvent(new Event("resize"))}catch(t){}}l("Transcribe using local AI",";",K(R().m(function t(){var e,n,r;return R().w(function(t){for(;;)switch(t.n){case 0:if(0!=(e=document.elementsFromPoint(w(),k()).filter(function(t){return"DIV"===t.tagName&&t.classList.contains("grading-canvas__image-capture-container")})).length){t.n=1;break}return console.warn("cannot find image under mouse"),t.a(2);case 1:n=e[0].querySelector("img.cm__lazy-img__img"),null!=V&&V.abort(),V=new AbortController,console.log("Starting AI transcription"),(r=$()).innerHTML="Processing...",GM_xmlhttpRequest({method:"POST",url:"http://localhost:3000/vision",headers:{"Content-Type":"application/json"},data:JSON.stringify({imageUrl:n.src}),responseType:"stream",onerror:function(t){console.error("Error while trying to transcribe",t)},onloadstart:function(){var t=K(R().m(function t(e){return R().w(function(t){for(;;)switch(t.n){case 0:X(r,e);case 1:return t.a(2)}},t)}));return function(e){return t.apply(this,arguments)}}()});case 2:return t.a(2)}},t)}))),J="Hide questions not being graded",Y=function(t){var e="cm-tweaks-fast-grading-switch-enabled";t?document.body.classList.add(e):document.body.classList.remove(e),et()},_.has(J)||_.set(J,[]),_.get(J).push(Y),Y(d(J));var nt=new MutationObserver(function(t){var e,n=Z(t);try{for(n.s();!(e=n.n()).done;){var r=e.value;if("attributes"===r.type&&"class"===r.attributeName){var o=r.target;o.matches("article.grading-canvas__item.grading-canvas__page")&&o.classList.contains("is-active")&&et()}}}catch(t){n.e(t)}finally{n.f()}});let rt;document.querySelectorAll("article.grading-canvas__item.grading-canvas__page").forEach(function(t){return nt.observe(t,{attributes:!0})}),new MutationObserver(function(t){var e,n=Z(t);try{for(n.s();!(e=n.n()).done;){var r,o=Z(e.value.addedNodes);try{for(o.s();!(r=o.n()).done;){var i=r.value;i instanceof HTMLElement&&i.matches("article.grading-canvas__item.grading-canvas__page")&&nt.observe(i,{attributes:!0})}}catch(t){o.e(t)}finally{o.f()}}}catch(t){n.e(t)}finally{n.f()}}).observe(document.body,{childList:!0,subtree:!0}),null==rt&&("function"==typeof unsafeWindow.requireModule?rt=unsafeWindow.requireModule("ember").default:console.warn("Running in degraded mode, window.requireModule is not accessible by userscript"));const ot=document.createElement("div");ot.classList.add("cm-tweaks-prefetched-image-holder"),document.body.appendChild(ot);var it,at,ct,lt,ut,st,ft,_t,dt,mt,pt,ht={},vt=[],gt=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,yt=Array.isArray;function bt(t,e){for(var n in e)t[n]=e[n];return t}function wt(t){t&&t.parentNode&&t.parentNode.removeChild(t)}function kt(t,e,n,r,o){var i={type:t,props:e,key:n,ref:r,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:null==o?++ct:o,__i:-1,__u:0};return null==o&&null!=at.vnode&&at.vnode(i),i}function Et(t){return t.children}function xt(t,e){this.props=t,this.context=e}function St(t,e){if(null==e)return t.__?St(t.__,t.__i+1):null;for(var n;e<t.__k.length;e++)if(null!=(n=t.__k[e])&&null!=n.__e)return n.__e;return"function"==typeof t.type?St(t):null}function Ct(t){var e,n;if(null!=(t=t.__)&&null!=t.__c){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if(null!=(n=t.__k[e])&&null!=n.__e){t.__e=t.__c.base=n.__e;break}return Ct(t)}}function Tt(t){(!t.__d&&(t.__d=!0)&&lt.push(t)&&!Nt.__r++||ut!=at.debounceRendering)&&((ut=at.debounceRendering)||st)(Nt)}function Nt(){for(var t,e,n,r,o,i,a,c=1;lt.length;)lt.length>c&&lt.sort(ft),t=lt.shift(),c=lt.length,t.__d&&(n=void 0,r=void 0,o=(r=(e=t).__v).__e,i=[],a=[],e.__P&&((n=bt({},r)).__v=r.__v+1,at.vnode&&at.vnode(n),Ht(e.__P,n,r,e.__n,e.__P.namespaceURI,32&r.__u?[o]:null,i,null==o?St(r):o,!!(32&r.__u),a),n.__v=r.__v,n.__.__k[n.__i]=n,Ut(i,n,a),r.__e=r.__=null,n.__e!=o&&Ct(n)));Nt.__r=0}function At(t,e,n,r,o,i,a,c,l,u,s){var f,_,d,m,p,h,v,g=r&&r.__k||vt,y=e.length;for(l=Lt(n,e,g,l,y),f=0;f<y;f++)null!=(d=n.__k[f])&&(_=-1==d.__i?ht:g[d.__i]||ht,d.__i=f,h=Ht(t,d,_,o,i,a,c,l,u,s),m=d.__e,d.ref&&_.ref!=d.ref&&(_.ref&&zt(_.ref,null,d),s.push(d.ref,d.__c||m,d)),null==p&&null!=m&&(p=m),(v=!!(4&d.__u))||_.__k===d.__k?l=Pt(d,l,t,v):"function"==typeof d.type&&void 0!==h?l=h:m&&(l=m.nextSibling),d.__u&=-7);return n.__e=p,l}function Lt(t,e,n,r,o){var i,a,c,l,u,s=n.length,f=s,_=0;for(t.__k=new Array(o),i=0;i<o;i++)null!=(a=e[i])&&"boolean"!=typeof a&&"function"!=typeof a?(l=i+_,(a=t.__k[i]="string"==typeof a||"number"==typeof a||"bigint"==typeof a||a.constructor==String?kt(null,a,null,null,null):yt(a)?kt(Et,{children:a},null,null,null):null==a.constructor&&a.__b>0?kt(a.type,a.props,a.key,a.ref?a.ref:null,a.__v):a).__=t,a.__b=t.__b+1,c=null,-1!=(u=a.__i=Ot(a,n,l,f))&&(f--,(c=n[u])&&(c.__u|=2)),null==c||null==c.__v?(-1==u&&(o>s?_--:o<s&&_++),"function"!=typeof a.type&&(a.__u|=4)):u!=l&&(u==l-1?_--:u==l+1?_++:(u>l?_--:_++,a.__u|=4))):t.__k[i]=null;if(f)for(i=0;i<s;i++)null!=(c=n[i])&&!(2&c.__u)&&(c.__e==r&&(r=St(c)),Gt(c,c));return r}function Pt(t,e,n,r){var o,i;if("function"==typeof t.type){for(o=t.__k,i=0;o&&i<o.length;i++)o[i]&&(o[i].__=t,e=Pt(o[i],e,n,r));return e}t.__e!=e&&(r&&(e&&t.type&&!e.parentNode&&(e=St(t)),n.insertBefore(t.__e,e||null)),e=t.__e);do{e=e&&e.nextSibling}while(null!=e&&8==e.nodeType);return e}function Ot(t,e,n,r){var o,i,a,c=t.key,l=t.type,u=e[n],s=null!=u&&!(2&u.__u);if(null===u&&null==t.key||s&&c==u.key&&l==u.type)return n;if(r>(s?1:0))for(o=n-1,i=n+1;o>=0||i<e.length;)if(null!=(u=e[a=o>=0?o--:i++])&&!(2&u.__u)&&c==u.key&&l==u.type)return a;return-1}function Mt(t,e,n){"-"==e[0]?t.setProperty(e,null==n?"":n):t[e]=null==n?"":"number"!=typeof n||gt.test(e)?n:n+"px"}function It(t,e,n,r,o){var i,a;t:if("style"==e)if("string"==typeof n)t.style.cssText=n;else{if("string"==typeof r&&(t.style.cssText=r=""),r)for(e in r)n&&e in n||Mt(t.style,e,"");if(n)for(e in n)r&&n[e]==r[e]||Mt(t.style,e,n[e])}else if("o"==e[0]&&"n"==e[1])i=e!=(e=e.replace(_t,"$1")),a=e.toLowerCase(),e=a in t||"onFocusOut"==e||"onFocusIn"==e?a.slice(2):e.slice(2),t.l||(t.l={}),t.l[e+i]=n,n?r?n.u=r.u:(n.u=dt,t.addEventListener(e,i?pt:mt,i)):t.removeEventListener(e,i?pt:mt,i);else{if("http://www.w3.org/2000/svg"==o)e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if("width"!=e&&"height"!=e&&"href"!=e&&"list"!=e&&"form"!=e&&"tabIndex"!=e&&"download"!=e&&"rowSpan"!=e&&"colSpan"!=e&&"role"!=e&&"popover"!=e&&e in t)try{t[e]=null==n?"":n;break t}catch(t){}"function"==typeof n||(null==n||!1===n&&"-"!=e[4]?t.removeAttribute(e):t.setAttribute(e,"popover"==e&&1==n?"":n))}}function jt(t){return function(e){if(this.l){var n=this.l[e.type+t];if(null==e.t)e.t=dt++;else if(e.t<n.u)return;return n(at.event?at.event(e):e)}}}function Ht(t,e,n,r,o,i,a,c,l,u){var s,f,_,d,m,p,h,v,g,y,b,w,k,E,x,S,C,T=e.type;if(null!=e.constructor)return null;128&n.__u&&(l=!!(32&n.__u),i=[c=e.__e=n.__e]),(s=at.__b)&&s(e);t:if("function"==typeof T)try{if(v=e.props,g="prototype"in T&&T.prototype.render,y=(s=T.contextType)&&r[s.__c],b=s?y?y.props.value:s.__:r,n.__c?h=(f=e.__c=n.__c).__=f.__E:(g?e.__c=f=new T(v,b):(e.__c=f=new xt(v,b),f.constructor=T,f.render=Rt),y&&y.sub(f),f.props=v,f.state||(f.state={}),f.context=b,f.__n=r,_=f.__d=!0,f.__h=[],f._sb=[]),g&&null==f.__s&&(f.__s=f.state),g&&null!=T.getDerivedStateFromProps&&(f.__s==f.state&&(f.__s=bt({},f.__s)),bt(f.__s,T.getDerivedStateFromProps(v,f.__s))),d=f.props,m=f.state,f.__v=e,_)g&&null==T.getDerivedStateFromProps&&null!=f.componentWillMount&&f.componentWillMount(),g&&null!=f.componentDidMount&&f.__h.push(f.componentDidMount);else{if(g&&null==T.getDerivedStateFromProps&&v!==d&&null!=f.componentWillReceiveProps&&f.componentWillReceiveProps(v,b),!f.__e&&null!=f.shouldComponentUpdate&&!1===f.shouldComponentUpdate(v,f.__s,b)||e.__v==n.__v){for(e.__v!=n.__v&&(f.props=v,f.state=f.__s,f.__d=!1),e.__e=n.__e,e.__k=n.__k,e.__k.some(function(t){t&&(t.__=e)}),w=0;w<f._sb.length;w++)f.__h.push(f._sb[w]);f._sb=[],f.__h.length&&a.push(f);break t}null!=f.componentWillUpdate&&f.componentWillUpdate(v,f.__s,b),g&&null!=f.componentDidUpdate&&f.__h.push(function(){f.componentDidUpdate(d,m,p)})}if(f.context=b,f.props=v,f.__P=t,f.__e=!1,k=at.__r,E=0,g){for(f.state=f.__s,f.__d=!1,k&&k(e),s=f.render(f.props,f.state,f.context),x=0;x<f._sb.length;x++)f.__h.push(f._sb[x]);f._sb=[]}else do{f.__d=!1,k&&k(e),s=f.render(f.props,f.state,f.context),f.state=f.__s}while(f.__d&&++E<25);f.state=f.__s,null!=f.getChildContext&&(r=bt(bt({},r),f.getChildContext())),g&&!_&&null!=f.getSnapshotBeforeUpdate&&(p=f.getSnapshotBeforeUpdate(d,m)),S=s,null!=s&&s.type===Et&&null==s.key&&(S=qt(s.props.children)),c=At(t,yt(S)?S:[S],e,n,r,o,i,a,c,l,u),f.base=e.__e,e.__u&=-161,f.__h.length&&a.push(f),h&&(f.__E=f.__=null)}catch(t){if(e.__v=null,l||null!=i)if(t.then){for(e.__u|=l?160:128;c&&8==c.nodeType&&c.nextSibling;)c=c.nextSibling;i[i.indexOf(c)]=null,e.__e=c}else{for(C=i.length;C--;)wt(i[C]);Ft(e)}else e.__e=n.__e,e.__k=n.__k,t.then||Ft(e);at.__e(t,e,n)}else null==i&&e.__v==n.__v?(e.__k=n.__k,e.__e=n.__e):c=e.__e=Dt(n.__e,e,n,r,o,i,a,l,u);return(s=at.diffed)&&s(e),128&e.__u?void 0:c}function Ft(t){t&&t.__c&&(t.__c.__e=!0),t&&t.__k&&t.__k.forEach(Ft)}function Ut(t,e,n){for(var r=0;r<n.length;r++)zt(n[r],n[++r],n[++r]);at.__c&&at.__c(e,t),t.some(function(e){try{t=e.__h,e.__h=[],t.some(function(t){t.call(e)})}catch(t){at.__e(t,e.__v)}})}function qt(t){return"object"!=typeof t||null==t||t.__b&&t.__b>0?t:yt(t)?t.map(qt):bt({},t)}function Dt(t,e,n,r,o,i,a,c,l){var u,s,f,_,d,m,p,h=n.props,v=e.props,g=e.type;if("svg"==g?o="http://www.w3.org/2000/svg":"math"==g?o="http://www.w3.org/1998/Math/MathML":o||(o="http://www.w3.org/1999/xhtml"),null!=i)for(u=0;u<i.length;u++)if((d=i[u])&&"setAttribute"in d==!!g&&(g?d.localName==g:3==d.nodeType)){t=d,i[u]=null;break}if(null==t){if(null==g)return document.createTextNode(v);t=document.createElementNS(o,g,v.is&&v),c&&(at.__m&&at.__m(e,i),c=!1),i=null}if(null==g)h===v||c&&t.data==v||(t.data=v);else{if(i=i&&it.call(t.childNodes),h=n.props||ht,!c&&null!=i)for(h={},u=0;u<t.attributes.length;u++)h[(d=t.attributes[u]).name]=d.value;for(u in h)if(d=h[u],"children"==u);else if("dangerouslySetInnerHTML"==u)f=d;else if(!(u in v)){if("value"==u&&"defaultValue"in v||"checked"==u&&"defaultChecked"in v)continue;It(t,u,null,d,o)}for(u in v)d=v[u],"children"==u?_=d:"dangerouslySetInnerHTML"==u?s=d:"value"==u?m=d:"checked"==u?p=d:c&&"function"!=typeof d||h[u]===d||It(t,u,d,h[u],o);if(s)c||f&&(s.__html==f.__html||s.__html==t.innerHTML)||(t.innerHTML=s.__html),e.__k=[];else if(f&&(t.innerHTML=""),At("template"==e.type?t.content:t,yt(_)?_:[_],e,n,r,"foreignObject"==g?"http://www.w3.org/1999/xhtml":o,i,a,i?i[0]:n.__k&&St(n,0),c,l),null!=i)for(u=i.length;u--;)wt(i[u]);c||(u="value","progress"==g&&null==m?t.removeAttribute("value"):null!=m&&(m!==t[u]||"progress"==g&&!m||"option"==g&&m!=h[u])&&It(t,u,m,h[u],o),u="checked",null!=p&&p!=t[u]&&It(t,u,p,h[u],o))}return t}function zt(t,e,n){try{if("function"==typeof t){var r="function"==typeof t.__u;r&&t.__u(),r&&null==e||(t.__u=t(e))}else t.current=e}catch(t){at.__e(t,n)}}function Gt(t,e,n){var r,o;if(at.unmount&&at.unmount(t),(r=t.ref)&&(r.current&&r.current!=t.__e||zt(r,null,e)),null!=(r=t.__c)){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(t){at.__e(t,e)}r.base=r.__P=null}if(r=t.__k)for(o=0;o<r.length;o++)r[o]&&Gt(r[o],e,n||"function"!=typeof t.type);n||wt(t.__e),t.__c=t.__=t.__e=void 0}function Rt(t,e,n){return this.constructor(t,n)}function Bt(t,e,n){var r,o,i,a;e==document&&(e=document.documentElement),at.__&&at.__(t,e),o=(r="function"==typeof n)?null:n&&n.__k||e.__k,i=[],a=[],Ht(e,t=(!r&&n||e).__k=function(t,e,n){var r,o,i,a={};for(i in e)"key"==i?r=e[i]:"ref"==i?o=e[i]:a[i]=e[i];if(arguments.length>2&&(a.children=arguments.length>3?it.call(arguments,2):n),"function"==typeof t&&null!=t.defaultProps)for(i in t.defaultProps)void 0===a[i]&&(a[i]=t.defaultProps[i]);return kt(t,a,r,o,null)}(Et,null,[t]),o||ht,ht,e.namespaceURI,!r&&n?[n]:o?null:e.firstChild?it.call(e.childNodes):null,i,!r&&n?n:o?o.__e:e.firstChild,r,a),Ut(i,t,a)}it=vt.slice,at={__e:function(t,e,n,r){for(var o,i,a;e=e.__;)if((o=e.__c)&&!o.__)try{if((i=o.constructor)&&null!=i.getDerivedStateFromError&&(o.setState(i.getDerivedStateFromError(t)),a=o.__d),null!=o.componentDidCatch&&(o.componentDidCatch(t,r||{}),a=o.__d),a)return o.__E=o}catch(e){t=e}throw t}},ct=0,xt.prototype.setState=function(t,e){var n;n=null!=this.__s&&this.__s!=this.state?this.__s:this.__s=bt({},this.state),"function"==typeof t&&(t=t(bt({},n),this.props)),t&&bt(n,t),null!=t&&this.__v&&(e&&this._sb.push(e),Tt(this))},xt.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),Tt(this))},xt.prototype.render=Et,lt=[],st="function"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,ft=function(t,e){return t.__v.__b-e.__v.__b},Nt.__r=0,_t=/(PointerCapture)$|Capture$/i,dt=0,mt=jt(!1),pt=jt(!0);var Wt,Kt,$t,Jt,Yt=0,Vt=[],Xt=at,Qt=Xt.__b,Zt=Xt.__r,te=Xt.diffed,ee=Xt.__c,ne=Xt.unmount,re=Xt.__;function oe(t,e){Xt.__h&&Xt.__h(Kt,t,Yt||e),Yt=0;var n=Kt.__H||(Kt.__H={__:[],__h:[]});return t>=n.__.length&&n.__.push({}),n.__[t]}function ie(t){return Yt=1,function(t,e){var n=oe(Wt++,2);if(n.t=t,!n.__c&&(n.__=[de(void 0,e),function(t){var e=n.__N?n.__N[0]:n.__[0],r=n.t(e,t);e!==r&&(n.__N=[r,n.__[1]],n.__c.setState({}))}],n.__c=Kt,!Kt.__f)){var r=function(t,e,r){if(!n.__c.__H)return!0;var i=n.__c.__H.__.filter(function(t){return!!t.__c});if(i.every(function(t){return!t.__N}))return!o||o.call(this,t,e,r);var a=n.__c.props!==t;return i.forEach(function(t){if(t.__N){var e=t.__[0];t.__=t.__N,t.__N=void 0,e!==t.__[0]&&(a=!0)}}),o&&o.call(this,t,e,r)||a};Kt.__f=!0;var o=Kt.shouldComponentUpdate,i=Kt.componentWillUpdate;Kt.componentWillUpdate=function(t,e,n){if(this.__e){var a=o;o=void 0,r(t,e,n),o=a}i&&i.call(this,t,e,n)},Kt.shouldComponentUpdate=r}return n.__N||n.__}(de,t)}function ae(t,e){var n=oe(Wt++,3);!Xt.__s&&_e(n.__H,e)&&(n.__=t,n.u=e,Kt.__H.__h.push(n))}function ce(){for(var t;t=Vt.shift();)if(t.__P&&t.__H)try{t.__H.__h.forEach(se),t.__H.__h.forEach(fe),t.__H.__h=[]}catch(e){t.__H.__h=[],Xt.__e(e,t.__v)}}Xt.__b=function(t){Kt=null,Qt&&Qt(t)},Xt.__=function(t,e){t&&e.__k&&e.__k.__m&&(t.__m=e.__k.__m),re&&re(t,e)},Xt.__r=function(t){Zt&&Zt(t),Wt=0;var e=(Kt=t.__c).__H;e&&($t===Kt?(e.__h=[],Kt.__h=[],e.__.forEach(function(t){t.__N&&(t.__=t.__N),t.u=t.__N=void 0})):(e.__h.forEach(se),e.__h.forEach(fe),e.__h=[],Wt=0)),$t=Kt},Xt.diffed=function(t){te&&te(t);var e=t.__c;e&&e.__H&&(e.__H.__h.length&&(1!==Vt.push(e)&&Jt===Xt.requestAnimationFrame||((Jt=Xt.requestAnimationFrame)||ue)(ce)),e.__H.__.forEach(function(t){t.u&&(t.__H=t.u),t.u=void 0})),$t=Kt=null},Xt.__c=function(t,e){e.some(function(t){try{t.__h.forEach(se),t.__h=t.__h.filter(function(t){return!t.__||fe(t)})}catch(n){e.some(function(t){t.__h&&(t.__h=[])}),e=[],Xt.__e(n,t.__v)}}),ee&&ee(t,e)},Xt.unmount=function(t){ne&&ne(t);var e,n=t.__c;n&&n.__H&&(n.__H.__.forEach(function(t){try{se(t)}catch(t){e=t}}),n.__H=void 0,e&&Xt.__e(e,n.__v))};var le="function"==typeof requestAnimationFrame;function ue(t){var e,n=function(){clearTimeout(r),le&&cancelAnimationFrame(e),setTimeout(t)},r=setTimeout(n,35);le&&(e=requestAnimationFrame(n))}function se(t){var e=Kt,n=t.__c;"function"==typeof n&&(t.__c=void 0,n()),Kt=e}function fe(t){var e=Kt;t.__c=t.__(),Kt=e}function _e(t,e){return!t||t.length!==e.length||e.some(function(e,n){return e!==t[n]})}function de(t,e){return"function"==typeof e?e(t):e}var me=!1;function pe(){void 0!==unsafeWindow.feather?unsafeWindow.feather.replace():me||(me=!0,console.warn("Cannot use feather icons as script is running in content context"))}var he=0;function ve(t,e,n,r,o,i){e||(e={});var a,c,l=e;if("ref"in l)for(c in l={},e)"ref"==c?a=e[c]:l[c]=e[c];var u={type:t,props:l,key:n,ref:a,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--he,__i:-1,__u:0,__source:o,__self:i};if("function"==typeof t&&(a=t.defaultProps))for(c in a)void 0===l[c]&&(l[c]=a[c]);return at.vnode&&at.vnode(u),u}function ge(t){var e=t.name;return ae(function(){pe()},[]),ve("i",{"data-feather":e})}function ye(){return ve("button",{className:"modal__close",onClick:function(){var t=document.getElementById("cmt-settings-dialog");Bt(null,t),t.parentElement.removeChild(t)},children:ve(ge,{name:"x"})})}function be(t){var e=t.isEnabled,n=t.setEnabled,r=t.className,o=function(){var t=oe(Wt++,11);if(!t.__){for(var e=Kt.__v;null!==e&&!e.__m&&null!==e.__;)e=e.__;var n=e.__m||(e.__m=[0,0]);t.__="P"+n[0]+"-"+n[1]++}return t.__}();return ve(Et,{children:[ve("input",{id:o,className:"toggle-switch",role:"switch",type:"checkbox",checked:e,onChange:function(){return n(!e)}}),ve("label",{for:o,className:"toggle-switch-label small ".concat(null!=r?r:"")})]})}function we(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,o,i,a,c=[],l=!0,u=!1;try{if(i=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=i.call(n)).done)&&(c.push(r.value),c.length!==e);l=!0);}catch(t){u=!0,o=t}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(u)throw o}}return c}}(t,e)||ke(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ke(t,e){if(t){if("string"==typeof t)return Ee(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ee(t,e):void 0}}function Ee(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}Array.isArray;var xe=document.getElementsByClassName("grading-topbar__links");function Se(t){var e=t.name,n=t.onClick,r=t.isRemapping;return ve("li",{children:[ve("span",{className:"cmt-list-item-name",children:e}),ve("span",{className:"keybind-char code code--line ".concat(r?"remapping":""),onClick:n,children:c(e)})]})}function Ce(t){var e=t.name,n=we(ie(d(e)),2),r=n[0],o=n[1];return ve("li",{children:[ve("span",{className:"cmt-list-item-name",children:e}),ve(be,{className:"cmt-feature-flag-slider",isEnabled:r,setEnabled:function(t){!function(t,e){window.localStorage.setItem("CMT-FEATURE:"+t,e?"true":"false");const n=_.get(t);if(void 0!==n){const e=d(t);for(const t of n)t(e)}}(e,t),o(t)}})]})}var Te=[{name:"Keybinds",component:ve(function(){var t=function(t,e){var n=oe(Wt++,7);return _e(n.__H,e)&&(n.__=t(),n.__H=e,n.__h=t),n.__}(function(){return Array.from(a.keys())},[]),e=we(ie(null),2),n=e[0],r=e[1];return ae(function(){var t=function(t){if(null!=n){var e=t.key.toLowerCase();if("escape"===e)return void r(null);1!==e.length||t.ctrlKey||t.altKey||t.metaKey||t.shiftKey||(function(t,e){window.localStorage.setItem("CMT-KEYBIND:"+t,e)}(n,e),t.stopImmediatePropagation(),t.preventDefault(),r(null))}};return document.addEventListener("keydown",t),function(){return document.removeEventListener("keydown",t)}},[n]),ve("ul",{className:"cmt-settings-component-list",children:t.map(function(t){return ve(Se,{onClick:function(){return r(t)},isRemapping:n==t,name:t},t)})})},{})},{name:"Features",component:ve(function(){return ve("ul",{className:"cmt-settings-component-list",children:f.map(function(t){return ve(Ce,{name:t},t)})})},{})}];function Ne(){var t=we(ie(0),2),e=t[0],n=t[1];return ve("div",{className:"modal-lg",style:{height:636},children:[ve(ye,{}),ve("div",{className:"cmt-settings-dialog-split-pane",children:[ve("div",{className:"cmt-settings-dialog-tabs",children:Te.map(function(t,r){return ve("button",{className:"link--button ".concat(e==r?"cmt-active-tab":""),onClick:function(){return n(r)},children:t.name},t.name)})}),ve("div",{className:"cmt-settings-dialog-component",children:Te[e].component})]})]})}function Ae(){var t=document.createElement("div");t.id="cmt-settings-dialog",t.classList.add("cm-modal__backdrop","visible"),document.body.appendChild(t),Bt(ve(Ne,{}),t)}function Le(){var t,e=function(t){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=ke(t))){e&&(t=e);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,a=!1;return{s:function(){e=e.call(t)},n:function(){var t=e.next();return i=t.done,t},e:function(t){a=!0,o=t},f:function(){try{i||null==e.return||e.return()}finally{if(a)throw o}}}}(xe);try{for(e.s();!(t=e.n()).done;){var n=t.value;if(null==n.querySelector(".cmt-tweaks-settings-button")){var r=document.createElement("button");r.classList.add("grading-topbar__filter-link","link--button","feather-icon","cmt-tweaks-settings-button"),r.textContent="Tweaks";var o=document.createElement("i");o.setAttribute("data-feather","settings"),r.insertBefore(o,r.firstChild),r.addEventListener("click",Ae),n.insertBefore(r,n.firstChild),pe()}}}catch(t){e.e(t)}finally{e.f()}}function Pe(){xe.length>0?Le():new MutationObserver(function(t,e){xe.length>0&&(Le(),e.disconnect())}).observe(document.body,{childList:!0,subtree:!0})}Pe(),window.addEventListener("urlchange",Pe),GM_addStyle("li.tool__lib-comment,span.lib-comment__text>div.processed-text{--us-height-override: 30px;height:var(--us-height-override) !important;line-height:var(--us-height-override) !important}.grading-toolbar__submenu--library{width:236px}.cmt-waiting-for-digit .grading-sidebar__evaluation .evaluation__score-block{border-color:red}.cm-tweaks-comment-macro-indicator-container{display:none}.cmt-waiting-for-comment-idx .cm-tweaks-comment-macro-indicator-container{display:flex}.cm-tweaks-comment-macro-indicator-container{position:absolute;right:4px;bottom:50%;transform:translateY(50%)}.cm-tweaks-comment-macro-indicator{display:block;padding:1px;margin:0 2px;line-height:normal !important;background-color:#ccc;border:1px #777 solid}[data-darkreader-scheme=dark] .cm-tweaks-comment-macro-indicator{background-color:#444}.cmt-grading-timer{background-color:#000;font-family:monospace;color:green;font-size:24px;text-align:center}.cmt-grading-timer.cmt-grading-timer-lagging{color:red}.cmt-comment-virtualization-workaround{resize:both;position:absolute;top:56px;left:0;display:flex;flex-direction:column}.cmt-comment-virtualization-workaround>.grading-toolbar__submenu--library{resize:none;height:initial !important;position:static;width:100% !important;flex:1 0 auto;border-radius:0}.cmt-comment-virtualization-workaround{width:236px;overflow-y:auto;overflow-x:hidden;border:2px rgba(0,0,0,0) solid;border-radius:4px}.cmt-waiting-for-comment-idx .cmt-comment-virtualization-workaround{border-color:red}.cm-tweaks-comment-search li.tool__lib-comment:not(.cm-tweaks-search-matches){display:none}#cmt-ai-assist-popover{position:fixed;right:240px;top:5rem;background-color:#222;color:#fff;border-radius:1rem;width:600px;height:400px;z-index:1000;overflow-y:auto;padding:1em;font-size:14px}#cmt-ai-assist-popover p{margin-bottom:.5em}.cm-comment.is-editing{z-index:100}.cm-tweaks-fast-grading-switch-enabled .grading-canvas__container>.grading-canvas__item:not(.is-active){display:none}.cm-tweaks-prefetched-image-holder{position:absolute;top:0;left:0;z-index:0;visibility:hidden;pointer-events:none}.cm-tweaks-search-visual{position:absolute;top:.5em;right:.5em;display:none}.cmt-waiting-for-comment-idx .cm-tweaks-search-visual{display:block}.cm-tweaks-search-visual{color:#fff;font-weight:bold}[data-darkreader-scheme=dark] .cm-tweaks-search-visual{background-color:#444}.cmt-settings-dialog-split-pane{display:flex}.cmt-settings-dialog-split-pane .cmt-settings-dialog-tabs{flex:0;padding:1rem}.cmt-settings-dialog-split-pane .cmt-settings-dialog-tabs .cmt-active-tab{font-weight:bold}.cmt-settings-dialog-split-pane .cmt-settings-dialog-component{flex:1 1 auto;padding:1rem}.cmt-settings-component-list{margin-top:30px}.cmt-settings-component-list>li{border-bottom:1px gray solid;padding:.5rem 0;display:flex;align-items:center}.cmt-settings-component-list>li .cmt-list-item-name{flex:1 1 auto}.cmt-settings-component-list>li .keybind-char{flex:0;min-width:4rem;text-align:center;font-size:1.25em;cursor:pointer}.cmt-settings-component-list>li .keybind-char.remapping{color:#ff0}"),u("Add points to grade","a","cmt-waiting-for-digit",function(t){var e=parseInt(t,10);isNaN(e)||s(e)}),l("Decrement grade by 1 point","d",function(){s(-1)}),function(){var t;if(d("Pacing timer")){var r,o,i=0,a=e();s(),(r=new MutationObserver(function(){return s()})).observe(document.body,{childList:!0,subtree:!0});var c,u=null!==(t=n())&&void 0!==t?t:-1;window.addEventListener("urlchange",function(){var t=a;a=e();var r=n();null==r||u>=r||(u=r,t&&f(i-m()),p())}),l("Reset grading timer","\\",function(){f(0),p()}),document.hidden||v(),document.addEventListener("visibilitychange",function(){document.hidden?h():v()})}function s(){var t=document.querySelector(".grading-sidebar__container > .evaluation__list");if(t&&!t.parentElement.querySelector(".cmt-grading-timer")){var e=document.createElement("div");e.classList.add("cmt-grading-timer"),e.textContent="00:00",t.parentElement.appendChild(e),o=e,r&&r.disconnect()}}function f(t){i=t,o.textContent=function(t){var e=t<0?"-":"";t=Math.abs(t);var n=Math.floor(t/60),r=Math.floor(t%60);return"".concat(e).concat(n.toString().padStart(2,"0"),":").concat(r.toString().padStart(2,"0"))}(t),t<m()?o.classList.remove("cmt-grading-timer-lagging"):o.classList.add("cmt-grading-timer-lagging")}function _(){null!=o&&a&&f(i+1)}function p(){null!=c&&(h(),v())}function h(){null!=c&&(clearInterval(c),c=null)}function v(){null==c&&(c=setInterval(_,1e3))}}()})();