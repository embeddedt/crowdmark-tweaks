// ==UserScript==
// @name Crowdmark Tweaks
// @description Useful tweaks for Crowdmark
// @version 0.1.0-build.2025-10-10T00:28:18.623Z
// @author embeddedt
// @homepage https://github.com/embeddedt/crowdmark-tweaks
// @supportURL https://github.com/embeddedt/crowdmark-tweaks/issues
// @match https://app.crowdmark.com/*
// @connect app.crowdmark.com
// @downloadURL https://github.com/embeddedt/crowdmark-tweaks/raw/refs/heads/main/crowdmark-tweaks.user.js
// @grant GM_addStyle
// @grant GM_addElement
// @icon https://www.google.com/s2/favicons?sz=64&domain=crowdmark.com
// @namespace https://github.com/embeddedt
// @updateURL https://github.com/embeddedt/crowdmark-tweaks/raw/refs/heads/main/crowdmark-tweaks.meta.js
// ==/UserScript==

(()=>{"use strict";let t=new Set;function o(o){let n=t.size;return t.has(o)&&n--,n>0}function n(t){const o=t.target;return"INPUT"!==o.tagName&&"TEXTAREA"!==o.tagName&&!o.isContentEditable}function e(t,e){document.addEventListener("keydown",i=>{!n(i)||i.repeat||o(t)||i.key.toLowerCase()===t&&(i.stopImmediatePropagation(),i.preventDefault(),setTimeout(()=>e(),0))})}function i(e,i,r,l){const c=document.documentElement;let a="";function m(){c.classList.remove(i),t.delete(e),a=""}document.addEventListener("keydown",s=>{if(!n(s)||o(e)||l&&!l())return;const d=c.classList.contains(i),u=s.key.toLowerCase();if(d)if(1!==u.length||s.ctrlKey||s.altKey||s.metaKey||s.shiftKey)"Escape"===u&&m();else{a+=u,s.stopImmediatePropagation(),s.preventDefault();let t=!1;try{t=r(a)}catch(s){console.error("Error from keybind handler",s)}t||m()}else u===e&&(c.classList.add(i),t.add(e))})}function r(t){!function(t){if(t<0)return void console.error("refusing to enter negative grade");const o=function(){const t=document.querySelector(".evaluation__keypad"),o=Array.from(t.children).filter(t=>"BUTTON"===t.tagName),n=new Map;return o.forEach(t=>{const o=t.textContent.trim();o&&n.set(o,t)}),n}(),n=o.get("CLR");if(null==n)return void console.error("Can't find clear button");const e=[];for(;t>0;)e.unshift(t%10),t=Math.floor(t/10);n.click();for(let t of e){const n=o.get(t.toString());null==n?console.warn("Cannot find grading keypad button for",t):n.click()}}(function(){const t=document.querySelector(".evaluation__points");if(null==t)throw new Error("can't find current grade");let o=parseInt(t.textContent.trim(),10);return isNaN(o)&&(o=0),o}()+t)}GM_addStyle('li.tool__lib-comment,span.lib-comment__text>div.processed-text{--us-height-override: 30px;height:var(--us-height-override) !important;line-height:var(--us-height-override) !important}.grading-toolbar__submenu--library{width:236px}.cmt-waiting-for-digit .grading-sidebar__evaluation .evaluation__score-block{border-color:red}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(1)::before{display:block;content:"0";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(2)::before{display:block;content:"1";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(3)::before{display:block;content:"2";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(4)::before{display:block;content:"3";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(5)::before{display:block;content:"4";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(6)::before{display:block;content:"5";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(7)::before{display:block;content:"6";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(8)::before{display:block;content:"7";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(9)::before{display:block;content:"8";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}.cmt-waiting-for-comment-idx ul.grading-toolbar__submenu--library{border:2px red solid}'),function(){let t=0;i("a","cmt-waiting-for-digit",o=>{const n=parseInt(o,10);isNaN(n)||(t=n,r(n))}),e("u",()=>{t>0&&(r(-t),t=0)}),e("d",()=>{r(-1)})}();let l=0,c=0;var a,m;document.addEventListener("mousemove",t=>{l=t.clientX,c=t.clientY}),i("w","cmt-waiting-for-comment-idx",(a=function(){const t=new Map,o=document.querySelector("ul.grading-toolbar__submenu--library");if(o){const n=Array.from(o.querySelectorAll("li.tool__lib-comment:not(.lib-comment--no-comment)"));for(let o=0;o<n.length;o++){const e=n[o],i=e.querySelector("span:nth-child(1 of .MathJax) mphantom");if(null!=i){const o=i.textContent.trim();t.has(o)||t.set(o,e)}if(o<10){const n=((o+1)%10).toString();t.set(n,e)}}}return t},m=function(t){console.log("Auto-apply comment",t),function(t,o,n){const e=t.getBoundingClientRect(),i=e.left+e.width/2,r=e.top+e.height/2;function l(t,o,n,e=document.elementFromPoint(o,n)){if(!e)return void console.warn("can't find target to fire event to");const i=new MouseEvent(t,{bubbles:!0,cancelable:!0,clientX:o,clientY:n,buttons:1});e.dispatchEvent(i)}l("mousedown",i,r,t);for(let t=1;t<=20;t++)l("mousemove",i+t/20*(o-i),r+t/20*(n-r));l("mouseup",o,n,document.elementFromPoint(o,n))}(t,l,c)},t=>{const o=function(t,o){let n=null,e=0;for(const[i,r]of t)if(i.startsWith(o)){if(e++,e>1)return{status:"conflict"};n=r}return null!=n?{status:"unique",value:n}:{status:"none"}}(a(),t);return"none"==o.status?(console.warn("no matching value found"),!1):"conflict"==o.status||(m(o.value),!1)}),()=>{const t=document.elementFromPoint(l,c);return null!==t?.closest(".grading-canvas__image-capture-container")})})();