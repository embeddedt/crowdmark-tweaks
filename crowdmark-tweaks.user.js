// ==UserScript==
// @name Crowdmark Tweaks
// @description Useful tweaks for Crowdmark
// @version 0.1.0-build.2025-10-09T02:00:07.659Z
// @author embeddedt
// @homepage https://github.com/embeddedt/crowdmark-tweaks
// @supportURL https://github.com/embeddedt/crowdmark-tweaks/issues
// @match https://app.crowdmark.com/*
// @connect app.crowdmark.com
// @downloadURL https://github.com/embeddedt/crowdmark-tweaks/raw/refs/heads/main/crowdmark-tweaks.user.js
// @grant GM_addStyle
// @grant GM_addElement
// @icon https://www.google.com/s2/favicons?sz=64&domain=crowdmark.com
// @namespace https://github.com/embeddedt
// @updateURL https://github.com/embeddedt/crowdmark-tweaks/raw/refs/heads/main/crowdmark-tweaks.meta.js
// ==/UserScript==

(()=>{"use strict";let o=new Set;function t(t){let e=o.size;return o.has(t)&&e--,e>0}function e(o){const t=o.target;return"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName&&!t.isContentEditable}function n(o,n){document.addEventListener("keydown",i=>{!e(i)||i.repeat||t(o)||i.key.toLowerCase()===o&&(i.stopImmediatePropagation(),i.preventDefault(),setTimeout(()=>n(),0))})}function i(n,i,r){const l=document.documentElement;document.addEventListener("keydown",c=>{if(!e(c)||t(n))return;const a=l.classList.contains(i),m=c.key.toLowerCase();a?1!==m.length||c.ctrlKey||c.altKey||c.metaKey||c.shiftKey?m===n&&(l.classList.remove(i),o.delete(n)):(l.classList.remove(i),o.delete(n),c.stopImmediatePropagation(),c.preventDefault(),setTimeout(()=>r(m),0)):m===n&&(l.classList.add(i),o.add(n))})}function r(o){!function(o){if(o<0)return void console.error("refusing to enter negative grade");const t=function(){const o=document.querySelector(".evaluation__keypad"),t=Array.from(o.children).filter(o=>"BUTTON"===o.tagName),e=new Map;return t.forEach(o=>{const t=o.textContent.trim();t&&e.set(t,o)}),e}(),e=t.get("CLR");if(null==e)return void console.error("Can't find clear button");const n=[];for(;o>0;)n.unshift(o%10),o=Math.floor(o/10);e.click();for(let o of n){const e=t.get(o.toString());null==e?console.warn("Cannot find grading keypad button for",o):e.click()}}(function(){const o=document.querySelector(".evaluation__points");if(null==o)throw new Error("can't find current grade");let t=parseInt(o.textContent.trim(),10);return isNaN(t)&&(t=0),t}()+o)}GM_addStyle('li.tool__lib-comment,span.lib-comment__text>div.processed-text{--us-height-override: 30px;height:var(--us-height-override) !important;line-height:var(--us-height-override) !important}.grading-toolbar__submenu--library{width:236px}.cmt-waiting-for-digit .grading-sidebar__evaluation .evaluation__score-block{border-color:red}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(1)::before{display:block;content:"0";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(2)::before{display:block;content:"1";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(3)::before{display:block;content:"2";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(4)::before{display:block;content:"3";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(5)::before{display:block;content:"4";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(6)::before{display:block;content:"5";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(7)::before{display:block;content:"6";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(8)::before{display:block;content:"7";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}li.tool__lib-comment:not(.lib-comment--no-comment):nth-of-type(9)::before{display:block;content:"8";position:absolute;right:4px;bottom:4px;background-color:#444;padding:1px;border:1px #777 solid;line-height:normal !important}.cmt-waiting-for-comment-idx ul.grading-toolbar__submenu--library{border:2px red solid}'),function(){let o=0;i("a","cmt-waiting-for-digit",t=>{const e=parseInt(t,10);isNaN(e)||(o=e,r(e))}),n("u",()=>{o>0&&(r(-o),o=0)}),n("d",()=>{r(-1)})}();let l=0,c=0;document.addEventListener("mousemove",o=>{l=o.clientX,c=o.clientY}),i("w","cmt-waiting-for-comment-idx",o=>{!function(o){const t=document.elementFromPoint(l,c);if(null===t?.closest(".grading-canvas__image-capture-container"))return void console.warn("Mouse is not over exam paper");const e=document.querySelector("ul.grading-toolbar__submenu--library");if(!e)return;const n=e.querySelectorAll("li.tool__lib-comment:not(.lib-comment--no-comment)");let i=null;if(o>="0"&&o<="9"){const t=Number(o);if(t-1>=n.length)return void console.warn("Requested comment index is out of range");i=n[t-1]}else for(const t of n){const e=t.querySelector("span:nth-child(1 of .MathJax) mphantom");if(null!=e&&o===e.textContent.trim()){i=t;break}}null!=i?(console.log("Auto-apply comment",i),function(o,t,e){const n=o.getBoundingClientRect(),i=n.left+n.width/2,r=n.top+n.height/2;function l(o,t,e,n=document.elementFromPoint(t,e)){if(!n)return void console.warn("can't find target to fire event to");const i=new MouseEvent(o,{bubbles:!0,cancelable:!0,clientX:t,clientY:e,buttons:1});n.dispatchEvent(i)}l("mousedown",i,r,o);for(let o=1;o<=20;o++)l("mousemove",i+o/20*(t-i),r+o/20*(e-r));l("mouseup",t,e,document.elementFromPoint(t,e))}(i,l,c)):console.warn("no matching comment found")}(o)})})();